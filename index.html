<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<title>Tablelens Demo</title>
<script type="text/javascript" src="d3/d3.js"></script>
<link rel="stylesheet" type="text/css" href="d3/jquery.multiselect.css" />
<link rel="stylesheet" type="text/css" href="d3/style.css" />
<link rel="stylesheet" type="text/css" href="d3/prettify.css" />
<link rel="stylesheet" type="text/css" href="d3/jquery-ui.css" />
<script type="text/javascript" src="d3/jquery.js"></script>
<script type="text/javascript" src="d3/jquery-ui.min.js"></script>
<script type="text/javascript" src="d3/jquery.multiselect.js"></script>
<script type="text/javascript" src="d3/prettify.js"></script>
<script type="text/javascript">
$(function(){
	//$("body").css("zoom","80%");
	$("select#multiple").multiselect({
		selectedList: 1
	});
	$("select#multiple").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeAttr(numChecked,checkedItems);
     		 return numChecked + ' of ' + numTotal + ' checked';
  		 }
	});
	$("select#single").multiselect({
		multiple: false,
		header: "Select an sort-option",
		noneSelectedText: "SortOption",
		selectedList: 1
	});
	$("select#single").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeSort(checkedItems);
			 return checkedItems[0].value;
  		 }
	});
	$("select#group").multiselect({
		multiple: false,
		header: "Select an Color-Option",
		noneSelectedText: "ColorOption",
		selectedList: 1
	});
	
});
</script>
<style>
	#outer{
		background:white;
	}
	#color_control{
		float:left;
	}
	.select_rect{
 		 fill-opacity: 0.3;
 		 stroke: black;
 		 stroke-width: 1.5px;
	}
	.filter_circle{
		 fill-opacity:0.7;
		 stroke:white;
		 stroke-width:1.5px;
	}
	#inner{
		overflow-y:auto;
		overflow-x:hidden;
		position:relative;
		background:white;
	}
	#attr1,#attr2,#attr3,#attr4,#attr5,#attr6{
		position:relative;
	}
	#control_button{
		margin: auto;
  		position: absolute;
  		top: 0; left: 0; bottom: 0; right: 0;
	}
	#multiple{
		float:left;
	}
	#single{
		float:left;
		position:relative;
	}
	#group{
		float:left;
		position:relative;
	}
	#resetSelect{
		margin-top:10px;
		padding-left:30px;
		padding-right:30px;
		float:left;
	}
	#removeselected{
		margin-top:10px;
		padding-left:30px;
		padding-right:30px;
		float:left;
		position:relative;
	}
	#removeothers{
		margin-top:10px;
		float:left;
		padding-left:30px;
		padding-right:30px;
		position:relative;
	}
	#resetfilter{
		/*display:inline;*/
		margin-top:10px;
		float:left;
		padding-left:30px;
		padding-right:30px;
		position:relative;
	}
</style>
</head>
<body>
<div id = "outer">
	<div id="color_control">
	</div>
	<button id="attr1" onClick="sortName();">name</button>
	<button id="attr2" onClick="sortBat86();">bat86</button>
	<button id="attr3" onClick="sortHit86();">hits86</button>
	<button id="attr4" onClick="sortHRuns86();">hRuns86</button>
	<button id="attr5" onClick="sortRuns86();">runs86</button>
	<button id="attr6" onClick="sortRunbat86();">Runbat86</button>
  	<div id="inner"> 
    </div>
	<div id="control_button">
	<!--***************************************************************-->
	<form id="multiple">
	<select multiple="multiple" id="multiple" style="width:100px; top:5px;">
	<option value="option1">Bat86</option>
	<option value="option2">Hit86</option>
	<option value="option3">HRuns86</option>
	<option value="option4">Run86</option>
	<option value="option5">RunBat86</option>
	</select>
	</form>
	<!--****************************************************************-->
	<form id = "single">
		<select name="demo" id="single" style="width:100px; top:5px;">
		<option value="Bat86">Bat86</option>
		<option value="Hit86">Hit86</option>
		<option value="HRuns86">HRuns86</option>
		<option value="Run86">Run86</option>
		<option value="RunBat86">RunBat86</option>
		</select>
	</form>
	<!--*****************************************************************-->
	<form>
	<select name="example-optgroup"  id="group" size="5">
		<optgroup label="Group One">
			<option value="option1">uniformly with 1/5-sized parts</option>
			<option value="option2">uniformly with 1/4-sized parts</option>
			<option value="option3">uniformly with 1/3-sized parts</option>
		</optgroup>
		<optgroup label="Group Two">
			<option value="option4">10,50,90 percentiles</option>
			<option value="option5">25,50,75 percentiles</option>
			<option value="option6">5,25,75,95 percentiles</option>
		</optgroup>
	</select>
	</form>
	<button id="resetSelect" onClick="resetSelection();">  Reset Selection  </button>
	<button id="removeselected" onClick="removeSelected();">  Remove Selected  </button>
	<button id="removeothers" onClick="removeOthers();">  Remove Others  </button>
	<button id="resetfilter" onClick="resetfilter();">  Reset Filters  </button>
	</div>
</div>  
</body>
<script type="text/javascript">
	//outer rect
	var svgHeight = 550,svgXMin = 100,svgWidth = 1300 - 2 * svgXMin,svgXMax,svgYMin = 0,scgYMax;
	var tableMarginTopY = 30, tableMarginBottomY = 20, tableMarginLeftX = 80, tableMarginRightX = 20;
	//inner rect
	var InRectXMin = tableMarginLeftX;
	var InRectYMin = tableMarginTopY;
	var InRectWidth = svgWidth - tableMarginLeftX;
	var InRectHeight = svgHeight - tableMarginBottomY - tableMarginTopY;
	var InRectXMax = InRectXMin + InRectWidth;
	var InRectYMax = InRectYMin + InRectHeight;
	var ChangeRectHeight = InRectHeight;
	//inner svg 
	var baseballdata, render_baseballdata;
	var AttrNameArray = new Array();
	var AttrArray = ["name","bat86","hits86","hRuns86","runs86","Runbat86","num"];//
	var DisplayArray = new Array();
	DisplayArray.push(0);
	DisplayArray.push(1);
	DisplayArray.push(2);
	DisplayArray.push(3);
	DisplayArray.push(4);
	DisplayArray.push(5);
	var AttrArray = new Array();
	var AttrAllArray = [0,1,2,3,4,5,6];
	var ButtonArray = new Array();
	ButtonArray.push("attr1");
	ButtonArray.push("attr2");
	ButtonArray.push("attr3");
	ButtonArray.push("attr4");
	ButtonArray.push("attr5");
	ButtonArray.push("attr6");
	var AttrNum = 6, AttrAllNum = 6;
	//the number of the people recorded
	var humannum_sum = 322;
	var humannum = 322;
	var humannum_min = 0, humannum_max = 322;
	var svg, svg_color;
	var button_width = InRectWidth/AttrNum;
	var ScaleArray = new Array();
	var FocusArray = new Array();
	var yfocus_num = 0, focusY_min = -1, focusY_max = -1, top_middleY = 0, bottom_middleY = 0;
	var barheight = 1, focus_height = 20;
	var currentYNum = -1;
	var top_middleY = 0, bottom_middleY = 0;
	var total_event;
	var beginY_index = 0, afterY_index, beginY, afterY, upY_index;
	var select_focus = false;
	var baseballman1;
	var text_paddingX = 5, text_paddingY = 5;
	var down_Name = true, down_Bat86 = true, down_Hit86 = true, down_HRuns86 = true, down_Runs86 = true, down_Runbat86 = true;
	var e = d3.rgb(255,60,60);		//red
	var d = d3.rgb(250,68,7);		
	var c = d3.rgb(192,192,192);	//white
	var b = d3.rgb(109,117,250);	
	var a = d3.rgb(60,60,255);		//blue
	var blue = d3.rgb(255,0,0);
	var green = d3.rgb(0,255,0);
	var cs_array = new Array();
	var cs_name = ["cs1","cs2","cs3","cs4","cs5"];
	var cs_coord = new Array();
	cs_coord[0] = InRectYMin + 0.02 * InRectHeight;
	cs_coord[1] = InRectYMin + 0.25 * InRectHeight;
	cs_coord[2] = InRectYMin + 0.5  * InRectHeight;
	cs_coord[3] = InRectYMin + 0.75 * InRectHeight;
	cs_coord[4] = InRectYMin + 0.96 * InRectHeight;
	cs_array[0] = 0.00;
	cs_array[1] = 0.25;
	cs_array[2] = 0.5;
	cs_array[3] = 0.75;
	cs_array[4] = 1;
	var minValue = [0,16,1,0,0,0,1]
	var maxValue = [0,687,238,40,130,121,322];
	var quarter0Value = new Array();
	var quarter1Value = new Array();
	var quarter2Value = new Array();
	var quarter3Value = new Array();
	var quarter4Value = new Array();
	for(var i=0;i<minValue.length;i++){
		var difference = Math.floor((maxValue[i] - minValue[i]));
		quarter0Value[i] = Math.floor(minValue[i] + difference * cs_array[0]);
		quarter1Value[i] = Math.floor(minValue[i] + difference * cs_array[1]);
		quarter2Value[i] = Math.floor(minValue[i] + difference * cs_array[2]);
		quarter3Value[i] = Math.floor(minValue[i] + difference * cs_array[3]);
		quarter4Value[i] = Math.floor(minValue[i] + difference * cs_array[4]);
	}
	var filter_array = new Array();
	var filter_name = ["filter1","filter2"];
	filter_array.push(0.04);
	filter_array.push(0.96);
	var selectRectNum = -1;
	var FirstSelectFilterNum = -1, FirstSelectRectNum = -1;
	var moveFilter = false, moveSR = false;
	var filter_coord = new Array();
	filter_coord[0] = InRectYMin + 0.04 * InRectHeight;
	filter_coord[1] = InRectYMin + 0.96 * InRectHeight;
	var sortIndex = 1;
	var middleValue = new Array();
	var stop_num1 = 0, stop_num2 = 25, stop_num3 = 50, stop_num4 = 75, stop_num5 = 100;
	var NamePArray = new Array();
	var defs, linearGradient;
	NamePArray.push(quarter4Value[sortIndex]+"");
	NamePArray.push(quarter3Value[sortIndex]+"");
	NamePArray.push(quarter2Value[sortIndex]+"");
	NamePArray.push(quarter1Value[sortIndex]+"");
	NamePArray.push(quarter0Value[sortIndex]+"");
	for(var i=0;i<5;i++){
		middleValue[i] = minValue[sortIndex] + cs_array[i] * (maxValue[sortIndex] - minValue[sortIndex]);
	}
	for(var i=0;i<AttrAllNum;i++){
		ScaleArray[i] = d3.scale.linear()
			.range([0,button_width - 10])
			.domain([0,maxValue[i]]);
	}
	d3.csv("baseballman.csv",function(baseballman){
		//keep updating with the data
		/*render_baseballdata = new Array();
		for(var i=0;i<baseballman.length;i++){
			render_baseballdata[i] = baseballman[i];
		}
		baseballdata = new Array();
		for(var i=0;i<baseballman.length;i++){
			baseballdata[i] = baseballman[i];
		}*/
		render_baseballdata = baseballman;
		baseballdata = render_baseballdata;
		baseballman1 = baseballdata[0];
		for(attribute in baseballman1){
			AttrNameArray.push(attribute);
		}
		sortIndex = 1;
		sortBat86();
		barheight = InRectHeight/humannum;
		focus_height = 20;
		tablelens(render_baseballdata);
	});
	d3.select("#outer")
	.style("margin-left", svgXMin+"px")
	.style("margin-top", svgYMin+"px")
	.style("height", svgHeight+"px")
	.style("width", svgWidth+"px");
	
	d3.select("#color_control")
	.style("left", "0px")
	.style("top", InRectYMin + "px")
	.style("height", svgHeight+"px")
	.style("width", InRectXMin+"px");
	
	d3.select("#inner")
	.style("left", "0px")
	.style("top", "0px")
	.style("margin-left","0px")
	.style("height", InRectHeight+"px")
	.style("width", InRectWidth+"px");
	
	d3.select("#control_button")
	.style("left", "300px")
	.style("top", (InRectYMax+10) + "px")
	.style("height", (180) +"px")
	.style("width", InRectWidth+"px");
	
	d3.select("#attr1")
	.style("height",tableMarginTopY+"px")
	.style("width",button_width +"px")
	.style("margin-left","0px")
	.style("margin-right","0px");
	
	computeButtonWidth();

	svg = d3.select("#inner")
	.append("svg")
	.attr("width",InRectWidth)
	.attr("height",InRectHeight);
	
	svg_color = d3.select("#color_control")
	.append("svg")
	.attr("width",InRectWidth/2)
	.attr("height",svgHeight);
	
	defs = svg_color.append("defs");
	linearGradient = defs.append("linearGradient")
						.attr("id","linearColor")
						.attr("x1","0%")
						.attr("y1","0%")
						.attr("x2","0%")
						.attr("y2","100%");
	var stopArray = new Array();
	var stopNumArray = [stop_num1,stop_num2,stop_num3,stop_num4,stop_num5];
	var colorArray = [a,b,c,d,e];
	for(var i=0;i<5;i++){
		stopArray[i] = linearGradient.append("stop")
				.attr("offset",stopNumArray[i]+"%")
				.style("stop-color",colorArray[i].toString());
	}
	var drag = d3.behavior.drag()
    .origin(function(d) { return d; })
    .on("dragstart", dragstarted)
    .on("drag", dragged)
    .on("dragend", dragended);
	
	//添加一个矩形，并应用线性渐变
	svg_color.append("g")
	.attr("class","color_rect")
	.append("rect")
	.attr("x", InRectXMin - 45)
	.attr("y", InRectYMin)
	.attr("width", 30)
	.attr("height", InRectHeight)
	.style("fill","url(#" + linearGradient.attr("id") + ")");
	
	svg_color.selectAll(".select_rect_text")
	.append("g")
	.data(NamePArray)
	.enter()
	.append("text")
	.attr("class","select_rect_text")
	.attr("x",(InRectXMin - 30))
	.attr("y",function(d,i){
		return cs_coord[i]+8.5;
	})
	.attr("font-size",9)
	.attr("font-family","simsun")
	.text(function(d){
		return d;
	});
	
	svg_color.selectAll(".select_rect")
	.append("g")
	.data(cs_array)
	.enter()
	.append("rect")
	.attr("class","select_rect")
	.attr("x",(InRectXMin - 35))
	.attr("y",function(d,i){
		return cs_coord[i];
	})
	.attr("width",30)
	.attr("height",10)
	.on("mouseover",function(d,i){
		d3.select(this)
		.attr("fill","orange");
		FirstSelectRectNum = i;
	})
	.on("mouseout",function(d){
		d3.select(this)
		.attr("fill","gray");
	});
	
	svg_color.selectAll(".filter_circle")
	.append("g")
	.data(filter_array)
	.enter()
	.append("circle")
	.attr("class","filter_circle")
	.attr("cx",(InRectXMin - 46))
	.attr("cy",function(d,i){
		return filter_coord[i];
	})
	.attr("r",8)
	.on("mouseover",function(d,i){
		d3.select(this)
		.attr("fill","orange");
		FirstSelectFilterNum = i;
	})
	.on("mouseout",function(d){
		d3.select(this)
		.attr("fill","gray");
	});
	//****************************************************************
	//select focus by click or drag some area
	window.document.onmousedown = function(event){
		var begin_clickX = event.clientX;
		var begin_clickY = event.clientY;
		beginY = event.layerY;
		beginY_index = computeIndexY(beginY);
		if((begin_clickX>250)&&(begin_clickX<InRectXMax)&&(begin_clickY>InRectYMin)&&(begin_clickY<InRectYMax)){
			select_focus = true;
		}
		if(FirstSelectFilterNum!=-1){
			moveFilter = true;
			SelectFilterNum = FirstSelectFilterNum;
		}
		if(FirstSelectRectNum!=-1){
			moveSR = true;
		}
	}
	window.document.onmousemove = function(event){
		var filter_moveY = event.layerY;
		var cs_moveY = event.layerY;
		if(moveSR){
			moveFilter = false;
			if(FirstSelectRectNum == 0){
				if(cs_moveY > cs_coord[1] - 15){
					cs_moveY = cs_coord[1] - 15;
				}
				if(cs_moveY<InRectYMin){
					cs_moveY = InRectYMin;
				}
			}else if(FirstSelectRectNum == (cs_coord.length -1)){
				if(cs_moveY>InRectYMax - 15){
					cs_moveY = InRectYMax - 15;
				}
				if(cs_moveY<cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}else{
				if(cs_moveY > cs_coord[FirstSelectRectNum + 1] - 15){
					cs_moveY = cs_coord[FirstSelectRectNum + 1] - 15;
				}
				if(cs_moveY < cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}
			cs_coord[FirstSelectRectNum] = cs_moveY;
			svg_color.selectAll(".select_rect_text").remove();
			svg_color.selectAll(".select_rect_text")
			.append("g")
			.data(NamePArray)
			.enter()
			.append("text")
			.attr("class","select_rect_text")
			.attr("x",(InRectXMin - 30))
			.attr("y",function(d,i){
				return cs_coord[i]+8.5;
			})
			.attr("font-size",9)
			.attr("font-family","simsun")
			.text(function(d){
				return d;
			});
			svg_color.selectAll(".select_rect").remove();
			svg_color.selectAll(".select_rect")
			.append("g")
			.data(cs_array)
			.enter()
			.append("rect")
			.attr("class","select_rect")
			.attr("x",(InRectXMin - 35))
			.attr("y",function(d,i){
				return cs_coord[i];
			})
			.attr("width",30)
			.attr("height",10)
			.on("mouseover",function(d,i){
				d3.select(this)
				.attr("fill","orange");
				FirstSelectRectNum = i;
			})
			.on("mouseout",function(d){
				d3.select(this)
				.attr("fill","gray");
			});
		}
		//**********************************************************
		if(moveFilter){
			moveSR = false;
			FocusArray.splice(0,FocusArray.length);
			yfocus_num = 0;
			if(FirstSelectFilterNum == 0){
				if(filter_moveY>filter_coord[1] - 15){
					filter_moveY = filter_coord[1] - 15;
				}
				if(filter_moveY<InRectYMin){
					filter_moveY = InRectYMin;
				}
			}else{
				if(filter_moveY>InRectYMax){
					filter_moveY = InRectYMax;
				}
				if(filter_moveY<filter_coord[0] + 15){
					filter_moveY = filter_coord[0] + 15;
				}
			}
			filter_coord[FirstSelectFilterNum] = filter_moveY;
			svg_color.selectAll(".filter_circle").remove();
			svg_color.selectAll(".filter_circle")
				.append("g")
				.data(filter_array)
				.enter()
				.append("circle")
				.attr("class","filter_circle")
				.attr("cx",(InRectXMin - 46))
				.attr("cy",function(d,i){
					return filter_coord[i];
				})
				.attr("r",8)
				.on("mouseover",function(d,i){
					d3.select(this)
					.attr("fill","orange");
					FirstSelectFilterNum = i;
				})
				.on("mouseout",function(d){
					d3.select(this)
					.attr("fill","gray");
				});
		}	
		//*************************************************************
		if(select_focus){
			var moveY = event.layerY;
			var beginSmall = true;
			svg.select(".focus_rect").remove();
			if((beginY - moveY)>0){
				svg.append("g")
				.attr("class","focus_rect")
				.append("rect")
				.attr("x",0)
				.attr("y",moveY)
				.attr("height",(beginY - moveY))
				.attr("width",InRectWidth)
				.attr("fill-opacity",0.2)
				.attr("fill","gray")
				.attr("stroke","gray")
				.attr("stroke-width",1);
			}else{
				svg.append("g")
				.attr("class","focus_rect")
				.append("rect")
				.attr("x",0)
				.attr("y",beginY)
				.attr("height",(moveY - beginY))
				.attr("width",InRectWidth)
				.attr("fill-opacity",0.2)
				.attr("fill","gray")
				.attr("stroke","gray")
				.attr("stroke-width",1);
			}
		}
	}
	window.document.onmouseup = function(event){
		var upY = event.layerY;
		var filter_moveY = event.layerY;
		var cs_moveY = event.layerY;
		if(moveSR){
			moveFilter = false;
			if(FirstSelectRectNum == 0){
				if(cs_moveY > cs_coord[1] - 15){
					cs_moveY = cs_coord[1] - 15;
				}
				if(cs_moveY<InRectYMin){
					cs_moveY = InRectYMin;
				}
			}else if(FirstSelectRectNum == (cs_coord.length -1)){
				if(cs_moveY>InRectYMax){
					cs_moveY = InRectYMax - 15;
				}
				if(cs_moveY<cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}else{
				if(cs_moveY > cs_coord[FirstSelectRectNum + 1] - 15){
					cs_moveY = cs_coord[FirstSelectRectNum + 1] - 15;
				}
				if(cs_moveY < cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}
			stopNumArray[(4 - FirstSelectRectNum)] = Math.floor((InRectYMax - cs_moveY)/InRectHeight * 100);
			renderColor();
			computeColorRect();
			renderCSRect();
			renderCSText();
			svg.selectAll("*").remove();
			tablelens(render_baseballdata);
			cs_coord[FirstSelectRectNum] = cs_moveY;
			renderCSRect();
			moveSR = false;
			FirstSelectRectNum = -1;
		}
		//*****************************************
		if(moveFilter){
			moveSR = false;
			FocusArray.splice(0,FocusArray.length);
			yfocus_num = 0;
			if(FirstSelectFilterNum == 0){
				if(filter_moveY>filter_coord[1] - 15){
					filter_moveY = filter_coord[1] - 15;
				}
				if(filter_moveY<InRectYMin){
					filter_moveY = InRectYMin;
				}
			}else{
				if(filter_moveY>InRectYMax){
					filter_moveY = InRectYMax;
				}
				if(filter_moveY<filter_coord[0] + 15){
					filter_moveY = filter_coord[0] + 15;
				}
			}
			filter_coord[FirstSelectFilterNum] = filter_moveY;
			if(FirstSelectFilterNum == 0){
				humannum_max = Math.floor((InRectHeight - filter_moveY + InRectYMin)/InRectHeight * humannum_sum);　
			}else{
				humannum_min = Math.floor((InRectHeight - filter_moveY + InRectYMin)/InRectHeight * humannum_sum);
			}
			computeBarHeight();
			/*svg.selectAll("*").remove();
			tablelens(render_baseballdata);*/
			svg_color.selectAll(".filter_circle").remove();
			svg_color.selectAll(".filter_circle")
				.append("g")
				.data(filter_array)
				.enter()
				.append("circle")
				.attr("class","filter_circle")
				.attr("cx",(InRectXMin - 46))
				.attr("cy",function(d,i){
					return filter_coord[i];
				})
				.attr("r",8)
				.on("mouseover",function(d,i){
					d3.select(this)
					.attr("fill","orange");
					FirstSelectFilterNum = i;
				})
				.on("mouseout",function(d){
					d3.select(this)
					.attr("fill","gray");
				});
			moveFilter = false;
			FirstSelectFilterNum = -1;
		}
		//******************************************************************************
		var btnNum = event.button;
		if(btnNum == 0){
			if(currentYNum > 0){
				//*********************************
				var num = render_baseballdata[currentYNum].num;
				if(FocusArray.indexOf(num)==-1){
					FocusArray.push(num);
					yfocus_num++;
					if(focusY_max<0){
						focusY_max = currentYNum;
						focusY_min = currentYNum;
					}else{
						if(currentYNum>focusY_max){
							focusY_max = currentYNum;
						}
						if(currentYNum<focusY_min){
							focusY_min = currentYNum;
						}
					}
				}
				computeVarY();
				svg.selectAll("*").remove();
				tablelens(render_baseballdata);
		}	
		//******************************************************************************
		var up_clickY = event.clientY;
		if(up_clickY<30){
			beginY_index = -1;
		}
		upY_index = computeIndexY(upY);
		if(select_focus){
			if((beginY_index<=upY_index)&&(beginY_index>=0)&&(upY_index - beginY_index)>3){
				for(var i=beginY_index;i<=upY_index;i++){
					var num = render_baseballdata[i].num;
					if(FocusArray.indexOf(num)==-1){
						FocusArray.push(num);
						yfocus_num++;
						if(focusY_max<0){
							focusY_max = i;
							focusY_min = i;
						}else{
							if(i>focusY_max){
								focusY_max = i;
							}else if(i < focusY_min){
								focusY_min = i;
							}
						}
					}
				}
			}else if((beginY_index>=0)&&((beginY_index - upY_index)>3)){
				for(var i=upY_index;i<=beginY_index;i++){
					var num = render_baseballdata[i].num;
					if(FocusArray.indexOf(num)!=-1){
						var n = FocusArray.indexOf(num);
						FocusArray.splice(n,1);
						yfocus_num--;
						if(i==focusY_max){
							focusY_max = i-1;
						}else if(i==focusY_min){
							focusY_min = i+1;
						}
					}
				}
			}
		}
		select_focus = false;
		svg.select(".focus_rect").remove();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	//******************************************************
	window.document.onclick = function(event){
		total_event = event;
		svg.select(".focus_rect").remove();
		var btnNum = event.button;
		if(btnNum == 0){
			if(currentYNum > 0){
				//*********************************
				var num = render_baseballdata[currentYNum].num;
				if(FocusArray.indexOf(num)==-1){
					FocusArray.push(num);
					yfocus_num++;
					if(focusY_max<0){
						focusY_max = currentYNum;
						focusY_min = currentYNum;
					}else{
						if(currentYNum>focusY_max){
							focusY_max = currentYNum;
						}
						if(currentYNum<focusY_min){
							focusY_min = currentYNum;
						}
					}
				}
				computeVarY();
				svg.selectAll("*").remove();
				tablelens(render_baseballdata);
			}
		}
		//***********************************************
			select_focus = false;
			if(select_focus){
				var upY = event.layerY;
				var upY_index = computeIndexY(upY);
				if(beginY_index <= upY_index ){
					for(var i=beginY_index;i<=upY_index;i++){
						var num = baseballdata[i].num;
						if(FocusArray.indexOf(num)==-1){
							FocusArray.push(num);
							yfocus_num++;
							if(focusY_max<0){
								focusY_max = i;
								focusY_min = i;
							}else{
								if(i>focusY_max){
									focusY_max = i;
								}else if(i < focusY_min){
									focusY_min = i;
								}
							}
						}
					}
				}else{
					for(var i=upY_index;i<=beginY_index;i++){
						var num = baseballdata[i].num;
						if(FocusArray.indexOf(num)!=-1){
							var n = FocusArray.indexOf(num);
							FocusArray.splice(n,1);
							yfocus_num--;
							if(i==focusY_max){
								focusY_max = i-1;
							}else if(i==focusY_min){
								focusY_min = i+1;
							}
						}
					}
				}
				svg.select(".focus_rect").remove();
				computeVarY();
				svg.selectAll("*").remove();
				tablelens(baseballdata);
			}
		 }
	}
	function computeButtonWidth(){
		button_width = InRectWidth/AttrNum;
		for(var i=0;i<AttrAllNum;i++){
			ScaleArray[i] = d3.scale.linear()
				.range([0,button_width - 10])
				.domain([0,maxValue[i]]);
		}
		for(var i=0;i<AttrAllNum;i++){
			if(DisplayArray.indexOf(i)!=-1){
				d3.select("#"+ButtonArray[i])
				.style("height",tableMarginTopY+"px")
				.style("width",button_width +"px")
				.style("margin-left","-3px");
			}
		}
		for(var i=0;i<AttrAllNum;i++){
			if(DisplayArray.indexOf(i)==-1){
				d3.select("#"+ButtonArray[i])
				.style("display","none");
			}else{
				d3.select("#"+ButtonArray[i])
				.style("display","inline");
			}
		}
	}
	function computeBarHeight(){
		humannum = humannum_max - humannum_min;
		render_baseballdata = baseballdata.slice(humannum_min,humannum_max);
		barheight = InRectHeight/humannum;
		focus_height = 20;
	}
	//rerender the color of the histogram and the rect
	function renderColor(){
			svg_color.select("defs").remove();
			svg_color.select("defs")
			.select("linearGradient")
			.remove();
			defs = svg_color.append("defs");
			linearGradient = defs.append("linearGradient")
						.attr("id","linearColor")
						.attr("x1","0%")
						.attr("y1","100%")
						.attr("x2","0%")
						.attr("y2","0%");
			for(var i=0;i<5;i++){
				stopArray[i] = linearGradient.append("stop")
				.attr("offset",stopNumArray[i]+"%")
				.style("stop-color",colorArray[4-i].toString());
			}
			for(var i=0;i<minValue.length;i++){
				var difference = Math.floor((maxValue[i] - minValue[i]));
				quarter0Value[i] = Math.floor(minValue[i] + difference * stopNumArray[0]/100);
				quarter1Value[i] = Math.floor(minValue[i] + difference * stopNumArray[1]/100);
				quarter2Value[i] = Math.floor(minValue[i] + difference * stopNumArray[2]/100);
				quarter3Value[i] = Math.floor(minValue[i] + difference * stopNumArray[3]/100);
				quarter4Value[i] = Math.floor(minValue[i] + difference * stopNumArray[4]/100);
			}
	}
	//*************************************************************************
	function computeColorRect(){
		svg_color.selectAll("rect").remove();
		//添加一个矩形，并应用线性渐变
		svg_color.append("g")
		.attr("class","color_rect")
		.append("rect")
		.attr("x", InRectXMin - 45)
		.attr("y", InRectYMin)
		.attr("width", 30)
		.attr("height", InRectHeight)
		.style("fill","url(#" + linearGradient.attr("id") + ")");
		
	}
	//*************************************************************************
	function renderCSText(){
		NamePArray.splice(0,NamePArray.length);
		NamePArray.push(quarter4Value[sortIndex]+"");
		NamePArray.push(quarter3Value[sortIndex]+"");
		NamePArray.push(quarter2Value[sortIndex]+"");
		NamePArray.push(quarter1Value[sortIndex]+"");
		NamePArray.push(quarter0Value[sortIndex]+"");
		svg_color.selectAll(".select_rect_text").remove();
		svg_color.selectAll(".select_rect_text")
			.append("g")
			.data(NamePArray)
			.enter()
			.append("text")
			.attr("class","select_rect_text")
			.attr("x",(InRectXMin - 30))
			.attr("y",function(d,i){
				return cs_coord[i]+8.5;
			})
			.attr("font-size",9)
			.attr("font-family","simsun")
			.text(function(d){
				return d;
			});
	}
	//*************************************************************************
	function renderCSRect(){
		svg_color.selectAll(".select_rect").remove();
		svg_color.selectAll(".select_rect")
			.append("g")
			.data(cs_array)
			.enter()
			.append("rect")
			.attr("class","select_rect")
			.attr("x",(InRectXMin - 35))
			.attr("y",function(d,i){
				return cs_coord[i];
			})
			.attr("width",30)
			.attr("height",10)
			.on("mouseover",function(d,i){
				d3.select(this)
				.attr("fill","orange");
				FirstSelectRectNum = i;
			})
			.on("mouseout",function(d){
				d3.select(this)
				.attr("fill","gray");
			});
		svg_color.selectAll(".filter_circle").remove();
		svg_color.selectAll(".filter_circle")
			.append("g")
			.data(filter_array)
			.enter()
			.append("circle")
			.attr("class","filter_circle")
			.attr("cx",(InRectXMin - 46))
			.attr("cy",function(d,i){
				return filter_coord[i];
			})
			.attr("r",8)
			.on("mouseover",function(d,i){
				d3.select(this)
				.attr("fill","orange");
				FirstSelectFilterNum = i;
			})
			.on("mouseout",function(d){
				d3.select(this)
				.attr("fill","gray");
			});
	}
	//*************************************************************
	function computeVarY(){
		top_middleY = focusY_min * barheight;
		bottom_middleY = (focusY_max + 1 - yfocus_num) * barheight + yfocus_num * focus_height;
		ChangeRectHeight = InRectHeight + yfocus_num *(focus_height - barheight);
	}
	function computeColor(value,index){
		var compute4 = d3.interpolate(a,b);
		var linear4 = d3.scale.linear()
				.domain([quarter4Value[index],quarter3Value[index]])
				.range([0,1]);
		var compute3 = d3.interpolate(b,c);
		var linear3 = d3.scale.linear()
				.domain([quarter3Value[index],quarter2Value[index]])
				.range([0,1]);
		var compute2 = d3.interpolate(c,d);
		var linear2 = d3.scale.linear()
				.domain([quarter2Value[index],quarter1Value[index]])
				.range([0,1]);
		var compute1 = d3.interpolate(d,e);
		var linear1 = d3.scale.linear()
				.domain([quarter1Value[index],quarter0Value[index]])
				.range([0,1]);
		if(value>=quarter4Value[index]){
			return a;
		}
		if((value>=quarter3Value[index])&&(value<=quarter4Value[index])){
			return compute4(linear4(value));
		}
		else if((value>quarter2Value[index])&&(value<=quarter3Value[index])){
			return compute3(linear3(value));
		}
		else if((value>quarter1Value[index])&&(value<=quarter2Value[index])){
			return compute2(linear2(value));
		}
		else if((value>quarter0Value[index])&&(value<=quarter1Value[index])){
			return compute1(linear1(value));
		}else{
			return e;
		}
	}
	//**************************************************************
	function tablelens(render1_baseballdata){
		svg = d3.select("#inner")
		.select("svg")
		.attr("width",InRectWidth)
		.attr("height",ChangeRectHeight);
		var minCoordY = computeCoordY(humannum_min);
		var index = 0;
		var real_index = 1;
		var baseball_man = render_baseballdata[0];
		for(x in baseball_man){
			if(index > 0 && index < AttrAllNum){
				if(DisplayArray.indexOf(index)!=-1){
					var scale = ScaleArray[index];
					svg.selectAll(AttrArray[index])
					.data(render_baseballdata)
					.enter()
					.append("rect")
					.attr("x",function(d,i){
						return button_width * (real_index);
					})
					.attr("y",function(d,i){				
						return computeCoordY(i);
					})
					.attr("height",function(d,i){
						return DOIHeight(i);
					})
					.attr("width",function(d){
						return scale(d[x]);
					})
					//.attr("fill","steelblue")
					.classed(AttrArray[index],true)
					.style("fill",function(d,i){
						//if(index == sortIndex){
						var color = computeColor(getAttr(d,sortIndex),sortIndex);
						return  color;
						//}else{
						//	return "steelblue";
						//}
					})
					.on("mouseover",function(d,i){
						currentYNum = i;
					})
					.on("mouseout",function(d){
						currentYNum = -1;
					});
					real_index++;
				}
			}
			index++;
		}
		//*********************************************************
		for(var i=0;i<FocusArray.length;i++){
			var indexY = computeRealIndexY(FocusArray[i]);
			var focusx_top = computeCoordY(indexY);
			var focusx_bottom = focusx_top + focus_height;
			svg.append("g")
			.append("line")
			.attr("x1",0)
			.attr("x2",InRectWidth)
			.attr("y1",focusx_top)
			.attr("y2",focusx_top)
			.attr("stroke","gray")
			.attr("stroke-width",1);
		//*************************************************
			svg.append("g")
			.append("line")
			.attr("x1",0)
			.attr("x2",InRectWidth)
			.attr("y1",focusx_bottom)
			.attr("y2",focusx_bottom)
			.attr("stroke","gray")
			.attr("stroke-width",1);
		//*************************************************
			var baseballman = render_baseballdata[indexY];
			var index = 0;
			var real_index = 0;
			for(x in baseballman){
				if(DisplayArray.indexOf(index)!=-1){
					var attr = baseballman[x];
					svg.append("g")
					.append("text")
					.attr("x",(button_width * real_index + text_paddingX))
					.attr("y",focusx_bottom - text_paddingY)
					.attr("class","person")
					.attr("font-size",15)
					.attr("font-family","simsun")
					.text(baseballman[x]);
					real_index++;
				}
				index++;
			}
		}
		//*********************************************************
		/*svg.append("g").selectAll("line")
		.data(AttrAllArray)
		.enter()
		.append("line")
		.attr("x1",function(d,i){
			return (button_width) * (i);
		})
		.attr("x2",function(d,i){
			return (button_width) * (i);
		})
		.attr("y1",0)
		.attr("y2",InRectHeight)
		.attr("stroke","black")
		.attr("stroke-width",2);
		
		svg.append("g")
		.append("line")
		.attr("x1",0)
		.attr("x2",InRectWidth)
		.attr("y1",InRectHeight)
		.attr("y2",InRectHeight)
		.attr("stroke","black")
		.attr("stroke-width",4);*/
		//*********************************************************
/*		if((focusY_min>=0)&&(focusY_max>=0)){
			for(var i=focusY_min;i<=focusY_max;i++){
				var num = baseballdata[i].num;
				if(FocusArray.indexOf(num)!=-1){
					var baseballman = baseballdata[i];
					var index = 0;
					var text_y = computeCoordY(i+1-humannum_min);
					for(x in baseballman){
						var attr = baseballman[x];
						svg.append("g")
						.append("text")
						.attr("x",(button_width * index + text_paddingX))
						.attr("y",text_y - text_paddingY)
						.attr("class","person")
						.attr("font-size",15)
						.attr("font-family","simsun")
						.text(baseballman[x]);
						index++;
					}
				}
			}
		}
*/	}
	//*****************************************************************
	//get the attribute of the baseball man according to the index
	function getAttr(baseballman, focus_index){
		var index = 0;
		var attr;
		for(x in baseballman){
			if(index==focus_index){
				attr = baseballman[x];
				break;
			}
			index++;
		}
		return attr;
	}
	function computeRealIndexY(lastAttrY){
		var indexY = 0;
		for(var i=0;i<render_baseballdata.length;i++){
			if(lastAttrY == render_baseballdata[i].num){
				indexY = i;
				break;
			}
		}
		return indexY;
	}
	//**********************************************************
	function computeCoordYAll(indexY){
		var minY = computeCoordY(humannum_min);
		var coordY = computeCoordY(indexY + humannum_min);
		return coordY - minY;
	}
	function computeCoordY(indexY){
		//indexY = computeRealIndexY(indexY);
		var coordY = 0;
		//alert(index);
		if(yfocus_num == 0){
			coordY = indexY * barheight;
		}else if(indexY <= focusY_min){
			coordY = indexY * barheight;
		}else if(indexY <= focusY_max){
			var temp_coordY = top_middleY;
			for(var i=focusY_min;i<focusY_max;i++){
				var num = render_baseballdata[i].num;
				if(FocusArray.indexOf(num)==-1){
					temp_coordY = temp_coordY + barheight;
				}else{
					temp_coordY = temp_coordY + focus_height;
				}
				if(i == (indexY - 1)){
					coordY = temp_coordY;
					break;
				}
			}
		}else{
			coordY = bottom_middleY + (indexY - focusY_max - 1) * barheight;
		}
		return coordY;
	}
	//**********************************************************
	function computeIndexY(CoordY){
		var IndexY = 0;
		if(yfocus_num == 0){
			IndexY = Math.floor(CoordY/barheight);
		}else if(CoordY<=top_middleY){
			IndexY = Math.floor(CoordY/barheight);
		}else if(CoordY<=bottom_middleY){
			var temp_y = top_middleY;
			var belong_index = 0;
			for(var i=focusY_min;i<=focusY_max;i++){
				var num = render_baseballdata[i].num;
				if(FocusArray.indexOf(num)==-1){
					if((CoordY>=temp_y)&&(CoordY<=(temp_y+barheight))){
						belong_index = i;
						break;
					}else{
						temp_y = temp_y + barheight;
					}
				}else{
					if((CoordY>=temp_y)&&(CoordY<=(temp_y+focus_height))){
						belong_index = i;
						break;
					}else{
						temp_y = temp_y + focus_height;
					}
				}
			}
			IndexY = belong_index;
		}else{
			IndexY = Math.ceil((CoordY - bottom_middleY)/barheight) + focusY_max;
		}
		return IndexY;
	}
	//**********************************************************
	function DOIHeight(index){
		//not the original data
		var doi_height = 0;
		var num = render_baseballdata[index].num;
		if(FocusArray.indexOf(num)!=-1){
			//click location
			doi_height = focus_height;
		}else{
			doi_height = barheight;
		}
		return doi_height;
	};
	//***********************************************************
	function sortName(){
		if(down_Name){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return a.name - b.name;
			});
			down_Name = false;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return b.name - a.name;
			});
			down_Name = true;
		}
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	function sortBat86(){
		if(down_Bat86){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return a.bat86 - b.bat86;
			});
			down_Bat86 = false;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return b.bat86 - a.bat86;
			});
			down_Bat86 = true;
		}
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	function sortHit86(){
		if(down_Hit86){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return a.hits86 - b.hits86;
			});
			down_Hit86 = false;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return b.hits86 - a.hits86;
			});
			down_Hit86 = true;
		}
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	function sortHRuns86(){
		if(down_HRuns86){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return a.hRuns86 - b.hRuns86;
			});
			down_HRuns86 = false;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return b.hRuns86 - a.hRuns86;
			});
			down_HRuns86 = true;
		}
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	function sortRuns86(){
		if(down_Runs86){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return a.runs86 - b.runs86;
			});
			down_Runs86 = false;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return b.runs86 - a.runs86;
			});
			down_Runs86 = true;
		}
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	function sortRunbat86(){
		if(down_Runbat86){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return a.Runbat86 - b.Runbat86;
			});
			down_Runbat86 = false;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return b.Runbat86 - a.Runbat86;
			});
			down_Runbat86 = true;
		}
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	function computeMinMax(){
		 focusY_min = 322;
		 focusY_max = -1;
		 for(var i=humannum_min;i<humannum_max;i++){
		 	var num = baseballdata[i].num;
			if(FocusArray.indexOf(num)!=-1){
				if(i<focusY_min){
					focusY_min = i;
				}
				if(i>focusY_max){
					focusY_max = i;
				}
			}
		 }
	}
	//************************************************************
	function dragstarted(d) {
 		d3.event.sourceEvent.stopPropagation();
  		d3.select(this).classed("dragging", true);
	}
	function dragged(d){
  		d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
	}
	function dragended(d) {
  		d3.select(this).classed("dragging", false);
	}
	//************************************************************
	//reset the data seleted
	function resetSelection(){
		FocusArray.splice(0,FocusArray.length);
		yfocus_num = 0;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	//remove the data seleted
	function removeSelected(){
		for(var i=0;i<render_baseballdata.length;i++){
			if(FocusArray.indexOf(render_baseballdata[i].num)!=-1){
				render_baseballdata.splice(i,1);
				i--;
			}
		}
		FocusArray.splice(0,FocusArray.length);
		yfocus_num = 0;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	//remove other data
	function removeOthers(){
		for(var i=0;i<render_baseballdata.length;i++){
			if(FocusArray.indexOf(render_baseballdata[i].num)==-1){
				render_baseballdata.splice(i,1);
				i--;
			}
		}
		FocusArray.splice(0,FocusArray.length);
		yfocus_num = 0;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	//remove filters
	function resetfilter(){
		render_baseballdata = baseballdata.concat();
		FocusArray.splice(0,FocusArray.length);
		yfocus_num = 0;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		humannum_min = 0;
		humannum_max = 322;
		svg.selectAll("*").remove();
		tablelens(baseballdata);
	}
	//change the AttrNum
	function ChangeAttr(numChecked,checkedItems){
		AttrNum = numChecked + 1;
		DisplayArray = new Array();
		DisplayArray.push(0);
		for(var i=0;i<checkedItems.length;i++){
			if(checkedItems[i].value=="option1"){
				DisplayArray.push(i+1);
			}
			if(checkedItems[i].value=="option2"){
				DisplayArray.push(i+1);
			}
			if(checkedItems[i].value=="option3"){
				DisplayArray.push(i+1);
			}
			if(checkedItems[i].value=="option4"){
				DisplayArray.push(i+1);
			}
			if(checkedItems[i].value=="option5"){
				DisplayArray.push(i+1);
			}
		}
		computeButtonWidth();
		svg.selectAll("*").remove();
		tablelens(render_baseballdata);
	}
	//change the sort num
	function ChangeSort(checkedItems){
		if(checkedItems[0].value=="Bat86"){
			sortIndex = 1;
			svg.selectAll("*").remove();
			tablelens(render_baseballdata);
		}else if(checkedItems[0].value=="Hit86"){
			sortIndex = 2;
			svg.selectAll("*").remove();
			tablelens(render_baseballdata);
		}else if(checkedItems[0].value=="HRuns86"){
			sortIndex = 3;
			svg.selectAll("*").remove();
			tablelens(render_baseballdata);
		}else if(checkedItems[0].value=="Run86"){
			sortIndex = 4;
			svg.selectAll("*").remove();
			tablelens(render_baseballdata);
		}else if(checkedItems[0].value=="RunBat86"){
			sortIndex = 5;
			svg.selectAll("*").remove();
			tablelens(render_baseballdata);
		}
	}
</script>
</html>
