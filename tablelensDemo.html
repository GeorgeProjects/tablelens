<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<title>Tablelens Demo</title>
<script type="text/javascript" src="d3/d3.js"></script>
<link rel="stylesheet" type="text/css" href="d3/jquery.multiselect.css" />
<link rel="stylesheet" type="text/css" href="d3/style.css" />
<link rel="stylesheet" type="text/css" href="d3/prettify.css" />
<link rel="stylesheet" type="text/css" href="d3/jquery-ui.css" />
<script type="text/javascript" src="d3/jquery.js"></script>
<script type="text/javascript" src="d3/jquery-ui.min.js"></script>
<script type="text/javascript" src="d3/jquery.multiselect.js"></script>
<script type="text/javascript" src="d3/prettify.js"></script>
<script type="text/javascript">
$(function(){
	$("select#multiple_select").multiselect({
		selectedList: 1
	});
	$("select#multiple_select").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeAttr(numChecked,checkedItems);
     		 return numChecked + ' of ' + numTotal + ' checked';
  		 }
	});
	$("select#single_select").multiselect({
		multiple: false,
		header: "Select an filter-option",
		noneSelectedText: "option",
		selectedList: 1
	});
	$("select#single_select").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeColor(checkedItems);
			 return checkedItems[0].value;
  		 }
	});
	$("select#grouping_select").multiselect({
		multiple: false,
		header: "Select an sort-option",
		noneSelectedText: "SortOption",
		selectedList: 2
	});
	$("select#grouping_select").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeSort(checkedItems);
			 return checkedItems[0].value;
  		 }
	});	
	$("select#embedded_select").multiselect({
		multiple: false,
		header: "Select an sample data",
		noneSelectedText: "option",
		selectedList: 1
	});
	$("select#embedded_select").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeData(checkedItems);
			 return checkedItems[0].value;
  		 }
	});
	$("select#focus_select").multiselect({
		multiple: false,
		header: "Select an focus option",
		noneSelectedText: "option",
		selectedList: 1
	});
	$("select#focus_select").multiselect({
   		selectedText: function(numChecked, numTotal, checkedItems){
			 ChangeSelect(checkedItems);
			 return checkedItems[0].value;
  		 }
	});
});
</script>
<style>
	#outer{
		margin-left:-7px;
		margin-right:-7px;
		margin-bottom:-7px;
		padding-top:-5px;
	}
	#color_control{
		display:inline-block;
		background:#F6F6F6;
		width:70px;
		height:500px;
		margin-top:0px;
		margin-bottom:0px;
		margin-left:0px;
	}
	#paint_control{
		position:relative;
		margin-top:0px;
		display:inline-block;
	}
	#AttrButton{
		position:absolute;
		left:0;
		top:0;
		margin-top:0px;
	}
	#inner{
		position:absolute;
		background:yellow;
		overflow-y:auto;
		overflow-x:hidden;
		height:500px;
		background:white;
	}
	.select_rect{
 		 fill-opacity: 0.3;
 		 stroke: black;
 		 stroke-width: 1.5px;
	}
	.filter_circle{
		 fill-opacity:0.7;
		 stroke:white;
		 stroke-width:1.5px;
	}
	.attr_button{
		margin-top:0px;
		position:relative;
	}
	#control_button{
		background:#F6F6F6;
		height:55px;
		top:3px;
		margin-left:-7px;
		margin-right:-7px;
		margin-bottom:-7px;
		box-shadow: 0 1px 1px rgba(0,0,0,0.8);
  		position: relative;
  		top: 0; left: 0; bottom: 0; right: 0;
		text-align:center;
	}
	#form_control{
		text-align:center;
	}
	#button_control{
		text-align:center;
	}
	#multiple{
		display:inline-block;
		width:250px;
	}
	#single{
		display:inline-block;
		width:250px;
	}
	#grouping{
		display:inline-block;
		width:250px;
	}
	#resetSelect{
		margin-top:5px;
		display:inline-block;
		width:250px;
	}
	#removeselected{
		margin-top:5px;
		display:inline-block;
		width:250px;
	}
	#removeothers{
		margin-top:5px;
		display:inline-block;
		width:250px;
	}
	#resetfilter{
		margin-top:5px;
		display:inline-block;
		width:250px;
	}
	#page-wrapper {
	  background:#F6F6F6;
	  height:20px;
	  margin-top:-7px;
	  margin-left:-7px;
	  margin-right:-7px;
	  margin-bottom:-5px;
	  padding: 1em;
	  padding-left:77px;
	  min-height: 10px;
	  box-shadow: 0 1px 1px rgba(0,0,0,0.8);
	}
	h1 {
		margin-top: 0;
	}
	#file_select{
	}
	img {
	  max-width: 100%;
	}
	#fileInput{
	  display:inline-block;
	  margin-left:3px;
	}
	#embedded{
	  display:inline-block;
	  margin-right:3px;
	}
	#Focus{
	  display:inline-block;
	  margin-left:40px;
	  margin-right:3px;
	}
</style>
</head>
<body>
<div id="page-wrapper">
		<div id="file_select">
			CSV File:
			<input type="file" id="fileInput">
			<form id = "embedded">
				Embedded Data:
				<select name="embedded_data" id="embedded_select" style="width:100px; top:5px;">
					<option value="filmdata">filmdata</option>
					<option value="baseballdata">baseballdata</option>
					<option value="basketballdata">basketballdata</option>
				</select>
			</form>
			<form id = "Focus">
				Select Options:
				<select name="Focus_item" id="focus_select" style="width:100px; top:5px;">
					<option value="Detail">detail</option>
					<option value="Color">color</option>
				</select>
			</form>
		</div>
</div>
	<div id = "outer">
		<div id="color_control">
		</div>
		<div id="paint_control">
			<div id="AttrButton">
			</div>
			<div id="inner"> 
			</div>
		</div>
	</div> 
	<div id="control_button">
		<div id="form_control">
			<form id="multiple">
			<select multiple="multiple" id="multiple_select" style="width:100px; top:5px;">
			</select>
			</form>
			<!--****************************************************************-->
			<form id = "grouping">
				<select name="demo" id="grouping_select" style="width:100px; top:5px;">
				</select>
			</form>
			<!--*****************************************************************-->
			<form id = "single">
				<select name="demo" id="single_select" style="width:100px; top:5px;">
				</select>
			</form>
		</div>
		<div id="button_control">
			<button id="resetSelect" onClick="resetSelection();">ResetSelection</button>
			<button id="removeselected" onClick="removeSelected();">RemoveSelected</button>
			<button id="removeothers" onClick="removeOthers();">RemoveOthers</button>
			<button id="resetfilter" onClick="resetfilter();">ResetFilters</button>
		</div>
	</div> 
</body>
<script type="text/javascript">
	//read data
	//var screen_width = document.body.clientWidth;
//	var screen_height = document.body.clientHeight;
	var screen_width = window.screen.width;
	var screen_height = window.screen.height;
	var text = new String();
	var stringArray;
	var AttrName = new Array();
	var SelectAttrName = new Array();
	var ColorArray =["uniformly5","uniformly4","uniformly3","percentile1","percentile2"];
	var SortObject = new Object();
	var ManNum = 0;
	//outer rect
	var svgHeight = screen_height-190,svgXMin = 120,svgWidth = 1300 - 207,svgXMax,svgYMin = 0,scgYMax;
	var focusXMin = 250, focusXMax = 1300, focusYMin = 30, focusYMax = svgHeight;
	var tableMarginTopY = 30, tableMarginBottomY = 20, tableMarginLeftX = 80, tableMarginRightX = 20;
	var ColorXMin = 150, ColorXMax = 200, ColorYMin = 10, ColorYMax = 580;
	//inner rect
	var InRectXMin = tableMarginLeftX;
	var InRectYMin = tableMarginTopY;
	var InRectWidth = screen_width - InRectXMin; 
	var ButtonInRectWidth = InRectWidth - 10;
	var InRectHeight = svgHeight - tableMarginBottomY - tableMarginTopY;
	var InRectXMax = InRectXMin + InRectWidth;
	var InRectYMax = InRectYMin + InRectHeight;
	var ChangeRectHeight = InRectHeight;
	var paint_width = screen_width - InRectXMin;
	var TypeArray = new Array();
	//inner svg 
	var baseballman = new Array();
	var baseballdata = new Array();
	var render_baseballdata = new Array();
	var AttrArray = new Array();
	var AttrNum = 1, AttrAllNum = 1;
	var DisplayArray = new Array();
	var AttrArray = new Array();
	var AttrAllArray = new Array();
	var TableArray = new Array();
	var ButtonArray = new Array();
	ButtonArray.push("attr1");
	ButtonArray.push("attr2");
	ButtonArray.push("attr3");
	ButtonArray.push("attr4");
	ButtonArray.push("attr5");
	ButtonArray.push("attr6");
	//the number of the people recorded
	var humannum_sum = 322;
	var humannum = 322;
	var humannum_min = 0, humannum_max = 322;
	var svg, svg_color, svg_button;
	var button_width = ButtonInRectWidth/AttrNum;
	var XArray = new Array();
	var YArray = new Array();
	var ScaleArray = new Array();
	var FocusArray = new Array();
	var DetailArray = new Array();
	var yfocus_num = 0, focusY_min = -1, focusY_max = -1, top_middleY = 0, bottom_middleY = 0;
	var barheight = 3, focus_height = 20;
	var currentYNum = -1;
	var top_middleY = 0, bottom_middleY = 0;
	var total_event;
	var beginY_index = 0, afterY_index, beginX_index, afterX_index, beginY, afterY, upY_index, RectBeginY, RectBeginX, RectMoveY, RectMoveX, RectEndY, RectEndX;
	var detail_index = 0;
	var select_focus = false, select_detail = false;
	var baseballman1;
	var text_paddingX = 5, text_paddingY = 5;
	var down_Name = true, down_Bat86 = true, down_Hit86 = true, down_HRuns86 = true, down_Runs86 = true, down_Runbat86 = true, down_all = true;
	var e = d3.rgb(13,2,111);		//red
	var d = d3.rgb(114,99,252);		
	var c = d3.rgb(192,192,192);	//white
	var b = d3.rgb(217,205,62);	
	var a = d3.rgb(220,115,58);		//blue
	var blue = d3.rgb(255,0,0);
	var green = d3.rgb(0,255,0);
	var cs_array = new Array();
	var cs_name = ["cs1","cs2","cs3","cs4","cs5"];
	var cs_coord = new Array();
	cs_array[0] = 0.17;
	cs_array[1] = 0.33;
	cs_array[2] = 0.50;
	cs_array[3] = 0.66;
	cs_array[4] = 0.83;
	for(var i=0;i<cs_array.length;i++){
		cs_coord[i] = InRectYMin + cs_array[i] * InRectHeight;
	}
	var stopNumArray = new Array();
	for(var i=0;i<cs_array.length;i++){
		stopNumArray[i] = cs_array[i] * 100;
	}
	var stopArray = new Array();
	var colorArray = [a,b,c,d,e];
	var minValue = new Array();
	var maxValue = new Array();
	var quarter0Value = new Array();
	var quarter1Value = new Array();
	var quarter2Value = new Array();
	var quarter3Value = new Array();
	var quarter4Value = new Array();
	var minValue = [0,0,0,0,0,0,0];
	var maxValue = [0,0,0,0,0,0,0];
	var filter_array = new Array();
	var filter_name = ["filter1","filter2"];
	filter_array.push(0.00);
	filter_array.push(1.00);
	var selectRectNum = -1;
	var FirstSelectFilterNum = -1, FirstSelectRectNum = -1;
	var moveFilter = false, moveSR = false;
	var filter_coord = new Array();
	filter_coord[0] = InRectYMin + 0.00 * InRectHeight;
	filter_coord[1] = InRectYMin + 1.00 * InRectHeight;
	var sortIndex = 1;
	var middleValue = new Array();
	var NamePArray = new Array();
	var defs, linearGradient;
	button_width = ButtonInRectWidth/AttrNum;
	XArray = new Array();
	var select_option = new Array();
	var filter_option = new Array();
	var former_color, after_color;
	var paddingY = 36;
	var font_size = 0;
	var focus_one = false;
	var detail_num = 0;
	var DivArray = new Array();
	var DivObjectArray = new Array();
	var div_index = 0;
	var display_divNum = -1;
	var div_height = 0;
	var AddSvgIndexNum = 0;
	var AddSvgHeight = 0;
	var add_svg;
	var copy_baseballdata;
	var type_height = new Array();
	filter_option[0] = "Distributed uniformly with 1/6";
	filter_option[1] = "Distributed uniformly with 1/5";
	filter_option[2] = "Distributed uniformly with 1/4"
	filter_option[3] = "Distribute using 10,50,90";
	filter_option[4] = "Distribute using 25,50,75";
	//*******************************************************************************
	window.onload = function() {
			FocusArray.splice(0,FocusArray.length);
			var fileInput = document.getElementById('fileInput');
			var fileDisplayArea = document.getElementById('fileDisplayArea');
			fileInput.addEventListener('change', function(e) {
				var file = fileInput.files[0];
				var size = file.size;
				var textType = "application/vnd.ms-excel";
				var textType2 = "text/csv";
				if ((file.type == (textType))||(file.type == (textType2))) {
				  if(size<80000){
					var reader = new FileReader();
					reader.onload = function(e) {
						text = reader.result;
						//HandleData(text);
						render_baseballdata.splice(0,render_baseballdata.length);
						minValue.splice(0,minValue.length);
						maxValue.splice(0,maxValue.length);
						stringArray = text.split("\n");
						ManNum = stringArray.length - 1;
						AttrName = stringArray[0].split(",");
						/*for(var i=0;i<AttrName.length;i++){
							if(AttrName[i].length>5){
								AttrName[i] = AttrName[i].substring(0,5);
							}
						}*/
						AttrNum = AttrName.length;
						AttrAllNum = AttrName.length;
						var SampleArray = new Array();
						for(var i=0;i<ManNum-1;i++){
							SampleArray = stringArray[i+1].split(",");
							baseballman[i] = new Object();
							for(var j=0;j<AttrName.length;j++){
								//alert(typeof(SampleArray[j])+j);
								baseballman[i][AttrName[j]] = SampleArray[j];
							}
						}
						var num;
						var num_length = 0;
						for(var i=0;i<AttrName.length;i++){
							TableArray[i] = new Array();
							for(var j=0;j<ManNum-1;j++){
								if(i==0){
									TableArray[i][j] = baseballman[j][AttrName[i]];
								}else{
									num = baseballman[j][AttrName[i]];
									num_length = num.length;
									if(isNaN(num)){
										if(j==ManNum-2){
											TableArray[i][j] = num.substring(0,num_length-1);
											baseballman[j][AttrName[i]] = TableArray[i][j];
										}else{
											TableArray[i][j] = num;
											baseballman[j][AttrName[i]] = TableArray[i][j];
										}
									}else{
										TableArray[i][j] = parseFloat(num);
										baseballman[j][AttrName[i]] = TableArray[i][j];
									}
								}
							}
						}
						for(var i=0;i<AttrNum;i++){
							SortObject[AttrName[i]] = true;
						}
						for(var i=0;i<baseballman.length;i++){
							baseballman[i].num = i+1;
						}
						for(var i=0;i<AttrNum;i++){
							DisplayArray[i] = i;
						}
						copy_baseballdata = baseballman.concat();
						render_baseballdata = baseballman;
						baseballdata = render_baseballdata;
						sortIndex = 1;
						focus_height = 20;
						humannum_sum = render_baseballdata.length;
						humannum = render_baseballdata.length;
						humannum_min = 0, humannum_max = render_baseballdata.length;
						barheight = 3;
						focus_height = 20;
						if(barheight>(InRectHeight-150)/humannum_sum){
							barheight = Math.floor(((InRectHeight-150)/humannum_sum)*100)/100;
						}
						button_width = Math.floor(ButtonInRectWidth/AttrNum);
						computeVarY();
						for(var i=0;i<=AttrNum;i++){
							AttrAllArray[i] = i;
						}
						minValue.splice(0,minValue.length);
						maxValue.splice(0,maxValue.length);
						quarter0Value.splice(0,quarter0Value.length);
						quarter1Value.splice(0,quarter1Value.length);
						quarter2Value.splice(0,quarter2Value.length);
						quarter3Value.splice(0,quarter3Value.length);
						quarter4Value.splice(0,quarter4Value.length);
						ScaleArray.splice(0,ScaleArray.length);
						for(var i=0;i<AttrAllNum;i++){
							if(i==0){
								minValue[i] = 0;
								maxValue[i] = 0;
								TypeArray[i] = true;
							}else{
								minValue[i] = Array.min(TableArray[i]);
								maxValue[i] = Array.max(TableArray[i]);
								if(isNaN(minValue[i])||isNaN(maxValue[i])){
									//category type data
									TypeArray[i] = new Array();
									for(var j=0;j<humannum_sum;j++){
										if(TypeArray[i].indexOf(TableArray[i][j])==-1){
											TypeArray[i].push(TableArray[i][j]);
										}
									}
									minValue[i] = 0;
									maxValue[i] = TypeArray[i].length;
								}else{
									//numerical type data
									TypeArray[i] = true;
								}
							}	
						}
						for(var i=0;i<minValue.length;i++){
							var difference = Math.floor((maxValue[i] - minValue[i]));
							quarter0Value[i] = Math.floor(minValue[i] + difference * cs_array[0]);
							quarter1Value[i] = Math.floor(minValue[i] + difference * cs_array[1]);
							quarter2Value[i] = Math.floor(minValue[i] + difference * cs_array[2]);
							quarter3Value[i] = Math.floor(minValue[i] + difference * cs_array[3]);
							quarter4Value[i] = Math.floor(minValue[i] + difference * cs_array[4]);
						}
						for(var i=0;i<AttrAllNum;i++){
							XArray[i] = i * button_width + 3;
						}
						NamePArray.push(quarter4Value[sortIndex]+"");
						NamePArray.push(quarter3Value[sortIndex]+"");
						NamePArray.push(quarter2Value[sortIndex]+"");
						NamePArray.push(quarter1Value[sortIndex]+"");
						NamePArray.push(quarter0Value[sortIndex]+"");
						for(var i=0;i<AttrAllNum;i++){
							middleValue[i] = minValue[sortIndex] + cs_array[i] * (maxValue[sortIndex] - minValue[sortIndex]);
						}
						for(var i=0;i<AttrAllNum;i++){
							if(TypeArray[i]==true){
								ScaleArray[i] = d3.scale.linear()
								.range([0,button_width - 10])
								.domain([0,maxValue[i]]);
								type_height[i] = 0;
							}else{
								ScaleArray[i] = d3.scale.ordinal()
								.domain(TypeArray[i])
								.rangeBands([0,button_width-10]);
								type_height[i] = (button_width-10)/maxValue[i];
							}
						}
						SortFunction();
						d3.selectAll(".attr_button")
						.append("g")
						.data(AttrName)
						.append("button")
						.text(function(d,i){
							return AttrName[i]
						});
						d3.select("#AttrButton")
						.selectAll(".attr_button").remove();
						d3.select("#AttrButton")
						.selectAll(".attr_button")
						.append("g")
						.data(AttrName)
						.enter()
						.append("button")
						.attr("class","attr_button")
						.style("height",InRectYMin+"px")
						.style("width", (button_width) +"px")
						.style("y","0px")
						.on("click",function(d,i){
							sortAttr(d,i);
						})
						.text(function(d,i){
							return AttrName[i];
						});
						select_option.splice(0,select_option.length);
						for(var i=1;i<AttrName.length;i++){
							select_option[i-1] = AttrName[i];
						}
						//***********************************************
						d3.select("#multiple_select")
						.selectAll(".display_attr").remove();
						d3.select("#multiple_select")
						.selectAll(".display_attr")
						.append("g")
						.data(select_option)
						.enter()
						.append("option")
						.attr("selected","selected")
						.attr("class","display_attr")
						.attr("value", function(d){
							return d;
						})
						.text(function(d,i){
							return d;
						});
						$("select#multiple_select").multiselect('refresh');
						//*************************************************
						d3.select("#grouping_select")
						.selectAll(".sort_attr").remove();
						d3.select("#grouping_select")
						.selectAll(".sort_attr")
						.append("g")
						.data(select_option)
						.enter()
						.append("option")
						.attr("class","sort_attr")
						.attr("value",function(d){
							return d;
						})
						.text(function(d,i){
							return d;
						});
						$("select#grouping_select").multiselect('refresh');
						//**************************************************
						d3.select("#single_select")
						.selectAll(".color_option").remove();
						d3.select("#single_select")
						.selectAll(".color_option")
						.append("g")
						.data(filter_option)
						.enter()
						.append("option")
						.attr("class","color_option")
						.attr("value",function(d,i){
							return ColorArray[i];
						})
						.text(function(d,i){
							return d;
						});
						$("select#single_select").multiselect('refresh');
						sortIndex = 1;
						renderCSText();
						svg.selectAll("*").remove();
						tablelens();
					}
					reader.readAsText(file);
					}else{
						alert("File is too big!");
					}	
				} else {
					alert("File not supported!");
				}
			});
	}
	//*******************************************************************************************
	Array.min=function(array)
	{
    	return Math.min.apply(Math,array);
	}
	Array.max=function(array)
	{
    	return Math.max.apply(Math,array);
	}
	d3.select("#outer")
	.style("margin-left", -7+"px")
	.style("margin-right","-7px")
	//.style("padding-top","-7px")
	.style("margin-top", 0+"px")
	.style("height", svgHeight+"px")
	.style("width", (screen_width+14)+"px");
	
	d3.select("#color_control")
	.style("left", "0px")
	.style("top", "0px")
	.style("height", svgHeight+"px")
	.style("width", InRectXMin+"px");
	
	d3.select("#paint_control")
	.style("height",svgHeight+"px")
	.style("width",paint_width+"px");
	
	d3.select("#AttrButton")
	.style("top", "10px")
	.style("height", InRectYMin+"px")
	.style("width", InRectWidth+"px");
	
	d3.select("#inner")
	.style("left", "0px")
	.style("top", "40px")
	.style("margin-left","0px")
	.style("height", InRectHeight+"px")
	.style("width", paint_width+"px");
	
	div_height = InRectHeight -5 - baseballdata.length * barheight;
	var button_width = Math.floor((InRectWidth - 320)/4);
	
	computeButtonWidth();
	
	svg = d3.select("#inner")
	.append("svg")
	.attr("width",InRectWidth)
	.attr("height",InRectHeight);
	
	svg_color = d3.select("#color_control")
	.append("svg")
	.attr("width",InRectWidth/2)
	.attr("height",svgHeight);
	
	defs = svg_color.append("defs");
	linearGradient = defs.append("linearGradient")
						.attr("id","linearColor")
						.attr("x1","0%")
						.attr("y1","0%")
						.attr("x2","0%")
						.attr("y2","100%");
	for(var i=0;i<5;i++){
		stopArray[i] = linearGradient.append("stop")
				.attr("offset",stopNumArray[i]+"%")
				.style("stop-color",colorArray[i].toString());
	}	
	svg_color.append("g")
	.attr("class","color_rect")
	.append("rect")
	.attr("x", InRectXMin - 45)
	.attr("y", InRectYMin)
	.attr("width", 30)
	.attr("height", InRectHeight)
	.style("fill","url(#" + linearGradient.attr("id") + ")");
	
	renderColor();
	computeColorRect();
	renderCSText();
	computeSelectRect();
	computeFilter();
	//****************************************************************
	//select focus by click or drag some area
	window.document.onmousedown = function(event){
		var begin_clickX = event.clientX;
		var begin_clickY = event.clientY;
		beginY = event.layerY - paddingY;
		RectBeginY = event.layerY;
		RectBeginX = event.layerX;
		beginY_index = computeIndexY(RectBeginY);
		beginX_index = Math.floor(RectBeginX/button_width);
		/*if((FirstSelectFilterNum!=-1)&&(begin_clickX<ColorXMax)&&(begin_clickX>ColorXMin)
			&&(begin_clickY<ColorYMax)&&(begin_clickY>ColorYMin)){
			moveFilter = true;
			moveSR = false;
			SelectFilterNum = FirstSelectFilterNum;
		}*/
		if((begin_clickX>focusXMin)&&(begin_clickY>focusYMin)&&(begin_clickY<focusYMax)){//(begin_clickX<focusXMax)&&
			if(focus_one){
				select_focus = true;
				select_detail = false;
			}else{
				select_detail = true;
				select_focus = false;
			}
		}
		if((FirstSelectFilterNum!=-1)){
			moveFilter = true;
			moveSR = false;
			select_focus = false;
			select_detail = false;
			SelectFilterNum = FirstSelectFilterNum;
		}
		if((FirstSelectRectNum!=-1)){
			moveSR = true;
			select_focus = false;
			select_detail = false;
			moveFilter = false;
		}
	}
	window.document.onmousemove = function(event){
		var filter_moveY = event.layerY - paddingY;
		var cs_moveY = event.layerY - paddingY;
		if(moveSR){
			moveFilter = false;
			if(FirstSelectRectNum == 0){
				if(cs_moveY > cs_coord[1] - 15){
					cs_moveY = cs_coord[1] - 15;
				}
				if(cs_moveY<InRectYMin){
					cs_moveY = InRectYMin;
				}
			}else if(FirstSelectRectNum == (cs_coord.length - 1)){
				if(cs_moveY>InRectYMax){
					cs_moveY = InRectYMax;
				}
				if(cs_moveY<cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}else{
				if(cs_moveY > cs_coord[FirstSelectRectNum + 1] - 15){
					cs_moveY = cs_coord[FirstSelectRectNum + 1] - 15;
				}
				if(cs_moveY < cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}
			cs_coord[FirstSelectRectNum] = cs_moveY;
			svg_color.selectAll(".select_rect_text").remove();
			svg_color.selectAll(".select_rect_text")
			.append("g")
			.data(NamePArray)
			.enter()
			.append("text")
			.attr("class","select_rect_text")
			.attr("x",(InRectXMin - 23))
			.attr("y",function(d,i){
				return cs_coord[i]+5.5;
			})
			.attr("font-size",10)
			.attr("font-family","arial")
			.text(function(d){
				return d;
			});
			svg_color.selectAll(".select_rect").remove();
			svg_color.selectAll(".select_rect")
			.append("g")
			.data(cs_array)
			.enter()
			.append("circle")
			.attr("class","select_rect")
			.attr("cx",(InRectXMin - 15))
			.attr("cy",function(d,i){
				return cs_coord[i];
			})
			.attr("r",10)
			.on("mouseover",function(d,i){
				d3.select(this)
				.attr("fill","orange");
				FirstSelectRectNum = i;
				FirstSelectFilterNum = -1;
			})
			.on("mouseout",function(d){
				d3.select(this)
				.attr("fill","gray");
			});
		}
		//**********************************************************
		if(moveFilter){
			moveSR = false;
			FocusArray.splice(0,FocusArray.length);
			yfocus_num = 0;
			if(FirstSelectFilterNum == 0){
				if(filter_moveY>filter_coord[1] - 15){
					filter_moveY = filter_coord[1] - 15;
				}
				if(filter_moveY<InRectYMin){
					filter_moveY = InRectYMin;
				}
			}else{
				if(filter_moveY>InRectYMax){
					filter_moveY = InRectYMax;
				}
				if(filter_moveY<filter_coord[0] + 15){
					filter_moveY = filter_coord[0] + 15;
				}
			}
			filter_coord[FirstSelectFilterNum] = filter_moveY;
			svg_color.selectAll(".filter_circle").remove();
			svg_color.selectAll(".filter_circle")
				.append("g")
				.data(filter_array)
				.enter()
				.append("circle")
				.attr("class","filter_circle")
				.attr("cx",(InRectXMin - 46))
				.attr("cy",function(d,i){
					return filter_coord[i];
				})
				.attr("r",8)
				.on("mouseover",function(d,i){
					d3.select(this)
					.attr("fill","orange");
					FirstSelectFilterNum = i;
					FirstSelectRectNum = -1;
				})
				.on("mouseout",function(d){
					d3.select(this)
					.attr("fill","gray");
				});
		}	
		//*************************************************************
		if(select_detail){
				RectMoveY = event.layerY;
				svg.select(".detail_rect").remove();
				//var begin_x = beginX_index * button_width + 3;
				var begin_x = 0;
				if((RectBeginY - RectMoveY)>0){
					svg.append("g")
					.attr("class","detail_rect")
					.append("rect")
					.attr("x",begin_x)
					.attr("y",RectMoveY)
					.attr("height",(RectBeginY - RectMoveY))
					.attr("width",InRectWidth)
					.attr("fill-opacity",0.2)
					.attr("fill","gray")
					.attr("stroke","gray")
					.attr("stroke-width",1);
				}else{
					svg.append("g")
					.attr("class","detail_rect")
					.append("rect")
					.attr("x",begin_x)
					.attr("y",RectBeginY)
					.attr("height",(RectMoveY - RectBeginY))
					.attr("width",InRectWidth)
					.attr("fill-opacity",0.2)
					.attr("fill","gray")
					.attr("stroke","gray")
					.attr("stroke-width",1);
				}
		}
		//*************************************************************
		if(select_focus){
			var moveY = event.layerY - paddingY;
			RectMoveY = event.layerY;
			var beginSmall = true;
			svg.select(".focus_rect").remove();
			if((RectBeginY - RectMoveY)>0){
				svg.append("g")
				.attr("class","focus_rect")
				.append("rect")
				.attr("x",0)
				.attr("y",RectMoveY)
				.attr("height",(RectBeginY - RectMoveY))
				.attr("width",InRectWidth)
				.attr("fill-opacity",0.2)
				.attr("fill","gray")
				.attr("stroke","gray")
				.attr("stroke-width",1);
			}else{
				svg.append("g")
				.attr("class","focus_rect")
				.append("rect")
				.attr("x",0)
				.attr("y",RectBeginY)
				.attr("height",(RectMoveY - RectBeginY))
				.attr("width",InRectWidth)
				.attr("fill-opacity",0.2)
				.attr("fill","gray")
				.attr("stroke","gray")
				.attr("stroke-width",1);
			}
		}
	}
	window.document.onmouseup = function(event){
		var upY = event.layerY - paddingY;
		RectEndY = event.layerY;
		RectEndX = event.layerX;
		var filter_moveY = event.layerY - paddingY;
		var cs_moveY = event.layerY - paddingY;
		if(moveSR){
			display_divNum = -1;
			moveFilter = false;
			if(FirstSelectRectNum == 0){
				if(cs_moveY > cs_coord[1] - 15){
					cs_moveY = cs_coord[1] - 15;
				}
				if(cs_moveY<InRectYMin){
					cs_moveY = InRectYMin;
				}
			}else if(FirstSelectRectNum == (cs_coord.length -1)){
				if(cs_moveY>InRectYMax){
					cs_moveY = InRectYMax;
				}
				if(cs_moveY<cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}else{
				if(cs_moveY > cs_coord[FirstSelectRectNum + 1] - 15){
					cs_moveY = cs_coord[FirstSelectRectNum + 1] - 15;
				}
				if(cs_moveY < cs_coord[FirstSelectRectNum - 1] + 15){
					cs_moveY = cs_coord[FirstSelectRectNum - 1] + 15;
				}
			}
			var point_num = Math.floor((InRectYMax - cs_moveY)/InRectHeight * 100);
			stopNumArray[(4 - FirstSelectRectNum)] = point_num;
			cs_array[(4 - FirstSelectRectNum)] = point_num/100;
			cs_coord[FirstSelectRectNum] = cs_moveY;
			renderCSText();
			renderColor();
			computeColorRect();
			computeFilter();
			computeSelectRect();
			moveSR = false;
			FirstSelectRectNum = -1;
		}
		//****************************************************************
		if(moveFilter){
			display_divNum = -1;
			moveSR = false;
			FocusArray.splice(0,FocusArray.length);
			yfocus_num = 0;
			if(FirstSelectFilterNum == 0){
				if(filter_moveY>filter_coord[1] - 15){
					filter_moveY = filter_coord[1] - 15;
				}
				if(filter_moveY<InRectYMin){
					filter_moveY = InRectYMin;
				}
			}else{
				if(filter_moveY>InRectYMax){
					filter_moveY = InRectYMax;
				}
				if(filter_moveY<filter_coord[0] + 15){
					filter_moveY = filter_coord[0] + 15;
				}
			}
			filter_coord[FirstSelectFilterNum] = filter_moveY;
			if(FirstSelectFilterNum == 0){
					humannum_max = Math.floor((InRectHeight - filter_moveY + InRectYMin)/InRectHeight * humannum_sum);ã€€			
			}else{
					humannum_min = Math.floor((InRectHeight - filter_moveY + InRectYMin)/InRectHeight * humannum_sum);
			}
			computeBarHeight();
			svg_color.selectAll(".filter_circle").remove();
			svg_color.selectAll(".filter_circle")
				.append("g")
				.data(filter_array)
				.enter()
				.append("circle")
				.attr("class","filter_circle")
				.attr("cx",(InRectXMin - 46))
				.attr("cy",function(d,i){
					return filter_coord[i];
				})
				.attr("r",8)
				.on("mouseover",function(d,i){
					d3.select(this)
					.attr("fill","orange");
					FirstSelectFilterNum = i;
					FirstSelectRectNum = -1;
				})
				.on("mouseout",function(d){
					d3.select(this)
					.attr("fill","gray");
				});
			moveFilter = false;
			FirstSelectFilterNum = -1;
		}
		//******************************************************************************
		var btnNum = event.button;
		if(btnNum == 0){
			if((currentYNum > 0)&&(focus_one)){
				//*********************************
				var num = render_baseballdata[currentYNum].num;
				if(FocusArray.indexOf(num)==-1){
					FocusArray.push(num);
					yfocus_num++;
					if(focusY_max<0){
						focusY_max = currentYNum;
						focusY_min = currentYNum;
					}else{
						if(currentYNum>focusY_max){
							focusY_max = currentYNum;
						}
						if(currentYNum<focusY_min){
							focusY_min = currentYNum;
						}
					}
				}
				computeVarY();
		}	
		//******************************************************************************
		var up_clickY = event.clientY;
		if(up_clickY<30){
			beginY_index = -1;
		}
		upY_index = computeIndexY(RectEndY);
		afterX_index = Math.floor(RectEndX/button_width);
		//******************************************************************************
		if(beginX_index == afterX_index){
			if(select_detail){
				if((beginY_index<=upY_index)&&(beginY_index>=0)&&(upY_index - beginY_index)>3){
					if(beginX_index!=detail_index){
						DetailArray.splice(0,DetailArray.length);
					}
					detail_index = beginX_index;
					for(var i=beginY_index;i<=upY_index;i++){
						var num = render_baseballdata[i].num;
						if(DetailArray.indexOf(num)==-1){
							DetailArray.push(num);
						}
					}
				}else if((beginY_index>=0)&&((beginY_index - upY_index)>3)){
					if(beginX_index!=detail_index){
						DetailArray.splice(0,DetailArray.length);
					}
					detail_index = beginX_index;
					for(var i=upY_index;i<=beginY_index;i++){
						var num = render_baseballdata[i].num;
						if(DetailArray.indexOf(num)!=-1){
							var n = DetailArray.indexOf(num);
							DetailArray.splice(n,1);
						}
					}
				}
			}
		}
		//******************************************************************************
		if(select_focus){
			if((beginY_index<=upY_index)&&(beginY_index>=0)&&(upY_index - beginY_index)>3){
				DivArray[div_index] = render_baseballdata[upY_index].num;
				var div_object = new Object();
				div_object.beginYIndex = beginY_index;
				div_object.upYIndex = upY_index;
				div_object.beginYNum = render_baseballdata[beginY_index].num;
				div_object.upYNum = render_baseballdata[upY_index].num;
				DivObjectArray[div_index] = div_object;
				display_divNum = div_index;
				AddSvgIndexNum = upY_index - beginY_index;
				AddSvgHeight = AddSvgIndexNum * focus_height;
				//div_index++;
			}else if((beginY_index>=0)&&((beginY_index - upY_index)>3)){
				for(var i=upY_index;i<=beginY_index;i++){
					var num = render_baseballdata[i].num;
					if(FocusArray.indexOf(num)!=-1){
						var n = FocusArray.indexOf(num);
						FocusArray.splice(n,1);
						yfocus_num--;
						if(i==focusY_max){
							focusY_max = i-1;
						}else if(i==focusY_min){
							focusY_min = i+1;
						}
					}
				}
				if(display_divNum!=-1){
					if(upY_index<DivObjectArray[display_divNum].upYIndex){
						DivObjectArray[display_divNum].upYIndex = upY_index;
						DivObjectArray[display_divNum].upYNum = render_baseballdata[upY_index].num;
						AddSvgIndexNum = upY_index - DivObjectArray[display_divNum].beginYIndex;
						AddSvgHeight = AddSvgIndexNum * focus_height;
					}
					if((DivObjectArray[display_divNum].upYIndex)<=(DivObjectArray[display_divNum].beginYIndex)){
						display_divNum = -1;
					}
				}
			}
		}
		moveSR = false;
		moveFilter = false;
		select_focus = false;
		select_detail = false;
		FirstSelectFilterNum = -1;
		FirstSelectRectNum = -1;
		svg.select(".focus_rect").remove();
		computeVarY();
		svg.selectAll("*").remove();
		tablelens();
	}
	//******************************************************
	window.document.onclick = function(event){
		total_event = event;
		svg.select(".focus_rect").remove();
		var btnNum = event.button;
		if(btnNum == 0){
			if(currentYNum > 0){
				//*********************************
				var num = render_baseballdata[currentYNum].num;
				if(FocusArray.indexOf(num)==-1){
					FocusArray.push(num);
					yfocus_num++;
					if(focusY_max<0){
						focusY_max = currentYNum;
						focusY_min = currentYNum;
					}else{
						if(currentYNum>focusY_max){
							focusY_max = currentYNum;
						}
						if(currentYNum<focusY_min){
							focusY_min = currentYNum;
						}
					}
				}
				computeVarY();
				svg.selectAll("*").remove();
				tablelens();
			}
		}
		//***********************************************
			select_focus = false;
			select_detail = false;
			if(select_focus){
				var upY = event.layerY - paddingY;
				var upY_index = computeIndexY(upY);
				if(beginY_index <= upY_index ){
					for(var i=beginY_index;i<=upY_index;i++){
						var num = baseballdata[i].num;
						if(FocusArray.indexOf(num)==-1){
							FocusArray.push(num);
							yfocus_num++;
							if(focusY_max<0){
								focusY_max = i;
								focusY_min = i;
							}else{
								if(i>focusY_max){
									focusY_max = i;
								}else if(i < focusY_min){
									focusY_min = i;
								}
							}
						}
					}
				}else{
					for(var i=upY_index;i<=beginY_index;i++){
						var num = baseballdata[i].num;
						if(FocusArray.indexOf(num)!=-1){
							var n = FocusArray.indexOf(num);
							FocusArray.splice(n,1); 
							yfocus_num--;
							if(i==focusY_max){
								focusY_max = i-1;
							}else if(i==focusY_min){
								focusY_min = i+1;
							}
						}
					}
				}
				svg.select(".focus_rect").remove();
				computeVarY();
				svg.selectAll("*").remove();
				tablelens();
			}
		 }
		moveSR = false;
		moveFilter = false;
		select_focus = false;
		select_detail = false;
		FirstSelectFilterNum = -1;
		FirstSelectRectNum = -1;
	}
	//****************************************************************************
	function computeFilter(){
		svg_color.selectAll(".filter_circle").remove();
		svg_color.selectAll(".filter_circle")
		.append("g")
		.data(filter_array)
		.enter()
		.append("circle")
		.attr("class","filter_circle")
		.attr("cx",(InRectXMin - 46))
		.attr("cy",function(d,i){
			return filter_coord[i];
		})
		.attr("r",8)
		.on("mouseover",function(d,i){
			d3.select(this)
			.attr("fill","orange");
			FirstSelectFilterNum = i;
			FirstSelectRectNum = -1;
		})
		.on("mouseout",function(d){
			d3.select(this)
			.attr("fill","gray");
		});
	}
	//*************************************************************************
	function computeSelectRect(){
		svg_color.selectAll(".select_rect_text").remove();
		svg_color.selectAll(".select_rect_text")
		.append("g")
		.data(NamePArray)
		.enter()
		.append("text")
		.attr("class","select_rect_text")
		.attr("x",(InRectXMin - 23))
		.attr("y",function(d,i){
			return cs_coord[i]+5.5;
		})
		.attr("font-size",10)
		.attr("font-family","arial")
		.text(function(d){
			return d;
		});
		//********************************************
		svg_color.selectAll(".select_rect").remove();
		svg_color.selectAll(".select_rect")
		.append("g")
		.data(cs_array)
		.enter()
		.append("circle")
		.attr("class","select_rect")
		.attr("cx",(InRectXMin - 15))
		.attr("cy",function(d,i){
			return cs_coord[i];
		})
		.attr("r",10)
		.on("mouseover",function(d,i){
			d3.select(this)
			.attr("fill","orange");
			FirstSelectRectNum = i;
			FirstSelectFilterNum = -1;
		})
		.on("mouseout",function(d){
			d3.select(this)
			.attr("fill","gray");
		});
	}
	//*******************************************************
	function computeButtonWidth(){
		button_width = ButtonInRectWidth/AttrNum;
		d3.select("#AttrButton")
		.selectAll(".attr_button").remove();
		d3.select("#AttrButton")
		.selectAll(".attr_button")
		.append("g")
		.data(SelectAttrName)
		.enter()
		.append("button")
		.attr("class","attr_button")
		.style("height",InRectYMin+"px")
		.style("width", button_width +"px")
		.on("click",function(d){
			var index = AttrName.indexOf(d);
			sortAttr(d,index);
		})
		.text(function(d,i){
			return d;
		});
		for(var i=0;i<AttrAllNum;i++){
			XArray[i] = i * button_width + 3;
		}
		if(TypeArray.length>0){
			for(var i=0;i<AttrAllNum;i++){
				if(TypeArray[i]==true){
					ScaleArray[i] = d3.scale.linear()
					.range([0,button_width - 10])
					.domain([0,maxValue[i]]);
					type_height[i] = 0;
				}else{
					ScaleArray[i] = d3.scale.ordinal()
					.domain(TypeArray[i])
					.rangeBands([0,button_width-10]);
					type_height[i] = (button_width-10)/maxValue[i];
				}
			}	
		}
		for(var i=0;i<AttrAllNum;i++){
			if(DisplayArray.indexOf(i)!=-1){
				d3.select("#"+ButtonArray[i])
				.style("height",tableMarginTopY+"px")
				.style("width",button_width +"px")
				.style("margin-left","-3px");
			}
		}
		for(var i=0;i<AttrAllNum;i++){
			if(DisplayArray.indexOf(i)==-1){
				d3.select("#"+ButtonArray[i])
				.style("display","none");
			}else{
				d3.select("#"+ButtonArray[i])
				.style("display","inline");
			}
		}
	}
	function computeBarHeight(){
		humannum = humannum_max - humannum_min;
		render_baseballdata = baseballdata.slice(humannum_min,humannum_max);
		focus_height = 20;
	}
	//rerender the color of the histogram and the rect
	function renderColor(){
			svg_color.select("defs").remove();
			svg_color.select("defs")
			.select("linearGradient")
			.remove();
			defs = svg_color.append("defs");
			linearGradient = defs.append("linearGradient")
						.attr("id","linearColor")
						.attr("x1","0%")
						.attr("y1","100%")
						.attr("x2","0%")
						.attr("y2","0%");
			for(var i=0;i<5;i++){
				stopArray[i] = linearGradient.append("stop")
				.attr("offset",stopNumArray[i]+"%")
				.style("stop-color",colorArray[4-i].toString());
			}
			for(var i=0;i<minValue.length;i++){
				var difference = Math.floor((maxValue[i] - minValue[i]));
				quarter0Value[i] = Math.floor(minValue[i] + difference * stopNumArray[0]/100);
				quarter1Value[i] = Math.floor(minValue[i] + difference * stopNumArray[1]/100);
				quarter2Value[i] = Math.floor(minValue[i] + difference * stopNumArray[2]/100);
				quarter3Value[i] = Math.floor(minValue[i] + difference * stopNumArray[3]/100);
				quarter4Value[i] = Math.floor(minValue[i] + difference * stopNumArray[4]/100);
			}
	}
	//*************************************************************************
	function computeColorRect(){
		svg_color.selectAll("rect").remove();
		svg_color.append("g")
		.attr("class","color_rect")
		.append("rect")
		.attr("x", InRectXMin - 45)
		.attr("y", InRectYMin)
		.attr("width", 30)
		.attr("height", InRectHeight)
		.style("fill","url(#" + linearGradient.attr("id") + ")");
	}
	//*************************************************************************
	function renderCSText(){
		for(var i=0;i<minValue.length;i++){
			var difference = Math.floor((maxValue[i] - minValue[i]));
			quarter0Value[i] = Math.floor(minValue[i] + difference * cs_array[0]);
			quarter1Value[i] = Math.floor(minValue[i] + difference * cs_array[1]);
			quarter2Value[i] = Math.floor(minValue[i] + difference * cs_array[2]);
			quarter3Value[i] = Math.floor(minValue[i] + difference * cs_array[3]);
			quarter4Value[i] = Math.floor(minValue[i] + difference * cs_array[4]);
		}
		NamePArray.splice(0,NamePArray.length);
		NamePArray.push(quarter4Value[sortIndex]+"");
		NamePArray.push(quarter3Value[sortIndex]+"");
		NamePArray.push(quarter2Value[sortIndex]+"");
		NamePArray.push(quarter1Value[sortIndex]+"");
		NamePArray.push(quarter0Value[sortIndex]+"");
		svg_color.selectAll(".select_rect_text").remove();
		svg_color.selectAll(".select_rect_text")
			.append("g")
			.data(NamePArray)
			.enter()
			.append("text")
			.attr("class","select_rect_text")
			.attr("x",(InRectXMin - 23))
			.attr("y",function(d,i){
				return cs_coord[i]+5.5;
			})
			.attr("font-size",10)
			.attr("font-family","arial")
			.text(function(d){
				return d;
			});
	}
	//*************************************************************
	function computeVarY(){
		var div_num = DivArray.length;
		top_middleY = focusY_min * barheight;
		bottom_middleY = (focusY_max + 1 - yfocus_num) * barheight + yfocus_num * focus_height;
		ChangeRectHeight = yfocus_num * focus_height + (humannum_sum - yfocus_num) * barheight;
		if(display_divNum>=0){
			div_height = InRectHeight -5 - ChangeRectHeight;
			if(AddSvgHeight<=div_height){
				div_height = AddSvgHeight;
			}
			ChangeRectHeight = InRectHeight - 5;
		}
		var coord_y = 0;
		YArray[0] = 0; 
		var divNum = -1;
		if(display_divNum>=0){
			divNum = DivObjectArray[display_divNum].upYNum;
		}
		for(var i=1;i<render_baseballdata.length;i++){
			var num = render_baseballdata[i-1].num;
			if(FocusArray.indexOf(num)==-1){
				if(divNum != num){
					YArray[i] = YArray[i-1] + barheight;
				}else{
					YArray[i] = YArray[i-1] + barheight + div_height;
				}				
			}else{
				if(divNum != num){
					YArray[i] = YArray[i-1] + focus_height;
				}else{
					YArray[i] = YArray[i-1] + focus_height + div_height;
				}
			}
		}
	}
	function computeColor(value,index){
		if(TypeArray[index]!=true){
			value = TypeArray[index].indexOf(value);
		}
		var compute4 = d3.interpolate(a,b);
		var linear4 = d3.scale.linear()
				.domain([quarter4Value[index],quarter3Value[index]])
				.range([0,1]);
		var compute3 = d3.interpolate(b,c);
		var linear3 = d3.scale.linear()
				.domain([quarter3Value[index],quarter2Value[index]])
				.range([0,1]);
		var compute2 = d3.interpolate(c,d);
		var linear2 = d3.scale.linear()
				.domain([quarter2Value[index],quarter1Value[index]])
				.range([0,1]);
		var compute1 = d3.interpolate(d,e);
		var linear1 = d3.scale.linear()
				.domain([quarter1Value[index],quarter0Value[index]])
				.range([0,1]);
		if(value>=quarter4Value[index]){
			return a;
		}
		if((value>=quarter3Value[index])&&(value<=quarter4Value[index])){
			return compute4(linear4(value));
		}
		else if((value>quarter2Value[index])&&(value<=quarter3Value[index])){
			return compute3(linear3(value));
		}
		else if((value>quarter1Value[index])&&(value<=quarter2Value[index])){
			return compute2(linear2(value));
		}
		else if((value>quarter0Value[index])&&(value<=quarter1Value[index])){
			return compute1(linear1(value));
		}else{
			return e;
		}
	}
	function SortFunction(){
		var attr = AttrName[1];
		var scale = ScaleArray[1];
		if(down_Bat86){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return scale(a[attr]) - scale(b[attr]);
			});
			copy_baseballdata = copy_baseballdata.sort(function(a,b){
				return scale(a[attr]) - scale(b[attr]);
			});
			down_all = true;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return scale(b[attr]) - scale(a[attr]);
			});
			copy_baseballdata = copy_baseballdata.sort(function(a,b){
				return scale(b[attr]) - scale(a[attr]);
			});
			down_all = false;
		}
		computeMinMax();
		computeVarY();
	}
	//**************************************************************
	function tablelens(){
		//SortFunction();
		svg = d3.select("#inner")
		.select("svg")
		.attr("width",InRectWidth)
		.attr("height",ChangeRectHeight);
		var index = 0;
		var real_index = 1;
		var baseball_man = baseballdata[0];
		var color_num = 0;
		for(x in baseball_man){
			if(index > 0 && index < AttrAllNum){
				if(DisplayArray.indexOf(index)!=-1){
					var scale = ScaleArray[index];
					svg.selectAll(AttrArray[index])
					.data(render_baseballdata)
					.enter()
					.append("rect")
					.attr("x",function(d,i){
						if(TypeArray[index]==true){
							return XArray[real_index];
						}else{
							return (XArray[real_index] + scale(d[x]));
						}
					})
					.attr("y",function(d,i){				
						return YArray[i];
					})
					.attr("height",function(d,i){
						return DOIHeight(i);
					})
					.attr("width",function(d){
						if(TypeArray[index]==true){
							return scale(d[x]);
						}else{
							return type_height[index];
						}
					})
					.attr("id",function(d,i){
						return "x"+index+"y"+i;
					})
					.classed(AttrArray[index],true)
					.style("fill",function(d,i){
						color_num = render_baseballdata[i].num;
						var color;
						if(DetailArray.length!=0){
							if(DetailArray.indexOf(color_num)==-1){
								color = "gray";
							}else{
								color = "red";
							}
						}else{
							if(display_divNum>=0){
								var beginY_index = DivObjectArray[display_divNum].beginYIndex;
								var upY_index = DivObjectArray[display_divNum].upYIndex;
								if((i>=beginY_index)&&(i<=upY_index)){
									color = "red";
								}else{
									color = computeColor(d[AttrName[sortIndex]],sortIndex);
								}
							}else{
								color = computeColor(d[AttrName[sortIndex]],sortIndex);
							}
						}
						return  color;
					})
					.on("mouseover",function(d,i){
						FirstSelectFilterNum = -1;
						FirstSelectRectNum = -1;
						if(focus_one){
							d3.select(this).style("fill","green");
							currentYNum = i;
							if(display_divNum>=0){
								var id = d3.select(this).attr("id");
								add_svg.select("#"+id)
								.style("fill","green");
							}
						}else{
							d3.select(this).style("fill","green");
							currentYNum = -1;
						}
					})
					.on("mouseout",function(d,i){
						currentYNum = -1;
						var color;
						color_num = render_baseballdata[i].num;
						var id = d3.select(this).attr("id");
						if(focus_one){
							if(display_divNum>=0){
								var beginY_index = DivObjectArray[display_divNum].beginYIndex;
								var upY_index = DivObjectArray[display_divNum].upYIndex;
								if((i>=beginY_index)&&(i<=upY_index)){
									color = "red";
								}else{
									color = computeColor(d[AttrName[sortIndex]],sortIndex);
								}
								var add_color = computeColor(d[AttrName[sortIndex]],sortIndex);
								add_svg.select("#"+id).style("fill",add_color);
							}else{
								color = computeColor(d[AttrName[sortIndex]],sortIndex);
							}
							d3.select(this).style("fill",function(){
								return color;
							});
						}else{
							if(DetailArray.length!=0){
								if(DetailArray.indexOf(color_num)==-1){
									color = "gray";
								}else{
									color = "red";
								}
							}else{
								color = computeColor(d[AttrName[sortIndex]],sortIndex);
							}
							d3.select(this).style("fill",function(){
								return color;
							});
						}
					});
					real_index++;
				}
			}
			index++;
		}
		//*********************************************************
		//*********************************************************
		//add div
		if(display_divNum>=0){
			d3.selectAll(".add_div").remove();
			var div_name = "append_div";
			var up_indexY = DivObjectArray[display_divNum].upYIndex;
			var div_y = YArray[up_indexY] + 40;
			addElementDiv(div_name,div_y);
		}else{
			d3.selectAll(".add_div").remove();
		}
		//*********************************************************
		for(var i=0;i<FocusArray.length;i++){
			var indexY = computeRealIndexY(FocusArray[i]);
			var focusx_top = YArray[indexY];
			var focusx_bottom = focusx_top + focus_height;
			svg.append("g")
			.append("line")
			.attr("x1",0)
			.attr("x2",InRectWidth)
			.attr("y1",focusx_top)
			.attr("y2",focusx_top)
			.attr("stroke","gray")
			.attr("stroke-width",1);
		//*************************************************
			svg.append("g")
			.append("line")
			.attr("x1",0)
			.attr("x2",InRectWidth)
			.attr("y1",focusx_bottom)
			.attr("y2",focusx_bottom)
			.attr("stroke","gray")
			.attr("stroke-width",1);
		//*************************************************
			var baseballman = render_baseballdata[indexY];
			var index = 0;
			var real_index = 0;
			var font_size = 12;
			for(x in baseballman){
				if(DisplayArray.indexOf(index)!=-1){
					var attr = baseballman[x];
					svg.append("g")
					.append("text")
					.attr("x",(XArray[real_index] + text_paddingX))
					.attr("y",focusx_bottom - text_paddingY)
					.attr("class","person")
					.attr("font-size",font_size)
					.attr("font-family","arial")
					.text(baseballman[x]);
					real_index++;
				}
				index++;
			}
		}
	}
	//*****************************************************************
	//get the attribute of the baseball man according to the index
	function getAttr(baseballman, focus_index){
		var index = 0;
		var attr;
		for(x in baseballman){
			if(index==focus_index){
				attr = baseballman[x];
				break;
			}
			index++;
		}
		return attr;
	}
	function computeRealIndexY(lastAttrY){
		var indexY = 0;
		for(var i=0;i<render_baseballdata.length;i++){
			if(lastAttrY == render_baseballdata[i].num){
				indexY = i;
				break;
			}
		}
		return indexY;
	}
	//**********************************************************
	function computeIndexY(CoordY){
		var IndexY = 0;
		if(display_divNum>=0){
			var upY_index = DivObjectArray[display_divNum].upYIndex;
			var upY_coordinate = YArray[upY_index];
			if(CoordY<upY_coordinate){
				//make no change
			}else if((CoordY>upY_coordinate)&&(CoordY<(upY_coordinate+div_height))){
				CoordY = upY_coordinate;
			}else if((CoordY>=(upY_coordinate+div_height))){
				CoordY = CoordY - div_height;
			}
		}
		if(yfocus_num == 0){
			IndexY = Math.floor(CoordY/barheight);
		}else if(CoordY<=top_middleY){
			IndexY = Math.floor(CoordY/barheight);
		}else if(CoordY<=bottom_middleY){
			var temp_y = top_middleY;
			var belong_index = 0;
			for(var i=focusY_min;i<=focusY_max;i++){
				var num = render_baseballdata[i].num;
				if(FocusArray.indexOf(num)==-1){
					if((CoordY>=temp_y)&&(CoordY<=(temp_y+barheight))){
						belong_index = i;
						break;
					}else{
						temp_y = temp_y + barheight;
					}
				}else{
					if((CoordY>=temp_y)&&(CoordY<=(temp_y+focus_height))){
						belong_index = i;
						break;
					}else{
						temp_y = temp_y + focus_height;
					}
				}
			}
			IndexY = belong_index;
		}else{
			IndexY = Math.ceil((CoordY - bottom_middleY)/barheight) + focusY_max;
		}
		if(IndexY<0){IndexY = 0;}
		if(IndexY>(ManNum-1)){IndexY=(ManNum-1);}
		return IndexY;
	}
	//**********************************************************
	function DOIHeight(index){
		//not the original data
		var doi_height = 0;
		var num = render_baseballdata[index].num;
		if(FocusArray.indexOf(num)!=-1){
			//click location
			doi_height = focus_height;
		}else{
			doi_height = barheight;
		}
		return doi_height;
	};
	//***********************************************************
	function sortAttr(attr_name,index){
		var scale = ScaleArray[index];
		if(SortObject[attr_name]){
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return scale(a[attr_name]) - scale(b[attr_name]);
			});
			for(var i=0;i<AttrNum;i++){
				SortObject[AttrName[i]] = true;
			}
			SortObject[attr_name] = false;
			down_all = true;
		}else{
			render_baseballdata = render_baseballdata.sort(function(a,b){
				return scale(b[attr_name]) - scale(a[attr_name]);
			});
			SortObject[attr_name] = true;
			down_all = false;
		}
//		for(var i=0;i<AttrNum;i++){
//			if(attr_name==AttrName[i]){
//				sortIndex = i;
//				break;
//			}
//		}
		display_divNum = -1;
		computeMinMax();
		computeVarY();
		svg.selectAll("*").remove(); 
		tablelens();
	}
	function computeMinMax(){
		 focusY_min = humannum_sum;
		 focusY_max = -1;
		 for(var i=humannum_min;i<humannum_max;i++){
		 	var num = render_baseballdata[i].num;
			if(FocusArray.indexOf(num)!=-1){
				if(i<focusY_min){
					focusY_min = i;
				}
				if(i>focusY_max){
					focusY_max = i;
				}
			}
		 }
	}
	//************************************************************
	//reset the data seleted
	function resetSelection(){
		FocusArray.splice(0,FocusArray.length);
		display_divNum = -1;
		yfocus_num = 0;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		svg.selectAll("*").remove();
		tablelens();
	}
	//remove the data seleted
	function removeSelected(){
		var beginY_Index = DivObjectArray[display_divNum].beginYIndex;
		var upY_Index = DivObjectArray[display_divNum].upYIndex
		for(var i=beginY_Index;i<=upY_Index;i++){
			FocusArray.push(render_baseballdata[i].num);
		}
		for(var i=0;i<render_baseballdata.length;i++){
			if((FocusArray.indexOf(render_baseballdata[i].num)!=-1)){
				render_baseballdata.splice(i,1);
				i--;
			}
		}
		FocusArray.splice(0,FocusArray.length);
		display_divNum = -1;
		yfocus_num = 0;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		svg.selectAll("*").remove();
		tablelens();
	}
	//remove other data
	function removeOthers(){
		var beginY_Index = DivObjectArray[display_divNum].beginYIndex;
		var upY_Index = DivObjectArray[display_divNum].upYIndex
		for(var i=beginY_Index;i<=upY_Index;i++){
			FocusArray.push(render_baseballdata[i].num);
		}
		for(var i=0;i<render_baseballdata.length;i++){
			if(FocusArray.indexOf(render_baseballdata[i].num)==-1){
				render_baseballdata.splice(i,1);
				i--;
			}
		}
		FocusArray.splice(0,FocusArray.length);
		yfocus_num = 0;
		display_divNum = -1;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		svg.selectAll("*").remove();
		tablelens();
	}
	//remove filters
	function resetfilter(){
		render_baseballdata = copy_baseballdata.concat();
		FocusArray.splice(0,FocusArray.length);
		yfocus_num = 0;
		display_divNum = -1;
		focusY_min = -1;
		focusY_max = -1;
		computeVarY();
		humannum_min = 0;
		humannum_max = humannum_sum;
		svg.selectAll("*").remove();
		tablelens();
	}
	//change the AttrNum
	function ChangeAttr(numChecked,checkedItems){
		AttrNum = numChecked + 1;
		DisplayArray = new Array();
		SelectAttrName = new Array();
		DisplayArray.push(0);
		for(var i=0;i<checkedItems.length;i++){
			for(var j=0;j<AttrAllNum;j++){
				if(checkedItems[i].value == AttrName[j]){
					DisplayArray.push(j);
				}
			}
			if(checkedItems[i].value.substring(0,(checkedItems[i].value.length-1))
			 == AttrName[AttrAllNum - 1].substring(0,AttrName[AttrAllNum-1].length-1)){
			 	DisplayArray.push(AttrAllNum - 1);
			 }
		}
		for(var i=0;i<DisplayArray.length;i++){
			SelectAttrName.push(AttrName[DisplayArray[i]]);
		}
		computeButtonWidth();
		svg.selectAll("*").remove();
		tablelens();
	}
	//change the sort num
	function ChangeSort(checkedItems){
		for(var j=0;j<AttrAllNum;j++){
			if(checkedItems[0].value == AttrName[j]){
				sortIndex = j;
			}
		}
		if(checkedItems[0].value.substring(0,(checkedItems[0].value.length-1))
		    == AttrName[AttrAllNum - 1].substring(0,AttrName[AttrAllNum-1].length-1)){
			sortIndex = AttrAllNum - 1;
		}
		svg.selectAll("*").remove();
		tablelens();
	}
	//chenge the sample data
	function ChangeData(checkedItems){
		if(checkedItems[0].value=="filmdata"){
			var filename = "filmdata.csv";
			ReadData(filename);
		}
		if(checkedItems[0].value=="baseballdata"){
			var filename = "baseballman2.csv";
			ReadData(filename);
		}
		if(checkedItems[0].value=="basketballdata"){
			var filename = "baseballman.csv";
			ReadData(filename);
		}
	}
	//Change the Select item
	function ChangeSelect(checkedItems){
		if(checkedItems[0].value=="Detail"){
			focus_one = true;
			DetailArray.splice(0,DetailArray.length);
			tablelens();
		}
		if(checkedItems[0].value=="Color"){
			focus_one = false;
		}
	}
	//change the color
	function ChangeColor(checkedItems){
		if(checkedItems[0].value=="uniformly5"){
			cs_array[0] = 0.17;
			cs_array[1] = 0.33;
			cs_array[2] = 0.50;
			cs_array[3] = 0.66;
			cs_array[4] = 0.83;
			for(var i=0;i<cs_array.length;i++){
				cs_coord[i] = InRectYMin + cs_array[i]* InRectHeight;
			}
			for(var i=0;i<cs_array.length;i++){
				stopNumArray[i] = cs_array[i] * 100;
			}
			renderCSText();
			renderColor();
			computeColorRect();
			computeFilter();
			computeSelectRect();
			svg.selectAll("*").remove();
			tablelens();
		}else if(checkedItems[0].value=="uniformly4"){
			cs_array[0] = 0.00;
			cs_array[1] = 0.20;
			cs_array[2] = 0.40;
			cs_array[3] = 0.60;
			cs_array[4] = 0.80;
			for(var i=0;i<cs_array.length;i++){
				cs_coord[i] = InRectYMin + cs_array[i]* InRectHeight;
			}
			for(var i=0;i<cs_array.length;i++){
				stopNumArray[i] = cs_array[i] * 100;
			}
			renderCSText();
			renderColor();
			computeColorRect();
			computeFilter();
			computeSelectRect();
			svg.selectAll("*").remove();
			tablelens();
		}else if(checkedItems[0].value=="uniformly3"){
			cs_array[0] = 0.00;
			cs_array[1] = 0.25;
			cs_array[2] = 0.50;
			cs_array[3] = 0.75;
			cs_array[4] = 1.00;
			for(var i=0;i<cs_array.length;i++){
				cs_coord[i] = InRectYMin + cs_array[i] * InRectHeight;
			}
			for(var i=0;i<cs_array.length;i++){
				stopNumArray[i] = cs_array[i] * 100;
			}
			renderCSText();
			renderColor();
			computeColorRect();
			computeFilter();
			computeSelectRect();
			svg.selectAll("*").remove();
			tablelens();
		}else if(checkedItems[0].value=="percentile1"){
			var index1 = Math.floor(render_baseballdata.length * 0.1);
			var index2 = Math.floor(render_baseballdata.length * 0.5);
			var index3 = Math.floor(render_baseballdata.length * 0.9);
			cs_array[0] = 0.00;
			cs_array[1] = (render_baseballdata[index1][AttrName[sortIndex]] - minValue[sortIndex])/(maxValue[sortIndex] - minValue[sortIndex]);
			cs_array[2] = (render_baseballdata[index2][AttrName[sortIndex]] - minValue[sortIndex])/(maxValue[sortIndex] - minValue[sortIndex]);
			cs_array[3] = (render_baseballdata[index3][AttrName[sortIndex]] - minValue[sortIndex])/(maxValue[sortIndex] - minValue[sortIndex]);
			cs_array[4] = 1.00;
			for(var i=0;i<cs_array.length;i++){
				cs_coord[i] = InRectYMin + Math.floor(cs_array[i] * InRectHeight);
			}
			for(var i=0;i<cs_array.length;i++){
				stopNumArray[i] = Math.floor(cs_array[i] * 100);
			}
			renderColor();
			computeColorRect();
			renderCSText();
			computeFilter();
			computeSelectRect();
			svg.selectAll("*").remove();
			tablelens();
		}else if(checkedItems[0].value=="percentile2"){
			var index1 = Math.floor(render_baseballdata.length * 0.3);
			var index2 = Math.floor(render_baseballdata.length * 0.6);
			var index3 = Math.floor(render_baseballdata.length * 0.9);
			cs_array[0] = 0.00;
			cs_array[1] = (render_baseballdata[index1][AttrName[sortIndex]] - minValue[sortIndex])/(maxValue[sortIndex] - minValue[sortIndex]);
			cs_array[2] = (render_baseballdata[index2][AttrName[sortIndex]] - minValue[sortIndex])/(maxValue[sortIndex] - minValue[sortIndex]);
			cs_array[3] = (render_baseballdata[index3][AttrName[sortIndex]] - minValue[sortIndex])/(maxValue[sortIndex] - minValue[sortIndex]);
			cs_array[4] = 1.00;
			for(var i=0;i<cs_array.length;i++){
				cs_coord[i] = InRectYMin + Math.floor(cs_array[i] * InRectHeight);
			}
			for(var i=0;i<cs_array.length;i++){
				stopNumArray[i] = Math.floor(cs_array[i] * 100);
			}
			renderColor();
			computeColorRect();
			renderCSText();
			computeFilter();
			computeSelectRect();
			svg.selectAll("*").remove();
			tablelens();
		}
	}
	//***************************************************************************************
	function addElementDiv(div_name,top){
		d3.select("#paint_control")
		.append("div")
		.attr("id","add_div")
		.attr("class","add_div")
		.style("position","absolute")
		.style("left","0px")
		.style("top",top+"px")
		.style("width",paint_width+"px")
		.style("height",div_height+"px")
		.style("overflow-y","auto")
		.style("overflow-x","hidden")
		.style("background","white");
	   add_svg = d3.select("#add_div")
		.append("svg")
		.attr("id","add_svg")
		.attr("width",InRectWidth)
		.attr("height",AddSvgHeight);
		//*************************************
		var beginY_Index = 0;
		var upY_index = 0;
		if(display_divNum>=0){
			beginY_Index = DivObjectArray[display_divNum].beginYIndex;
			upY_index = DivObjectArray[display_divNum].upYIndex;
		}
		var append_array = new Array();
		for(var i=beginY_Index;i<=upY_index;i++){
			var index = i - beginY_Index;
			append_array[index] = render_baseballdata[i];
		}
	    var baseball_man = baseballdata[0];
		var real_index = 1;
		var index = 0; 
		for(x in baseball_man){
			if(index > 0 && index < AttrAllNum){
				if(DisplayArray.indexOf(index)!=-1){
					var scale = ScaleArray[index];
					add_svg.selectAll("."+AttrName[index])
					.append("g")
					.data(append_array)
					.enter()
					.append("rect")
					.attr("x",function(d,i){
						if(TypeArray[index]==true){
							return XArray[real_index];
						}else{
							return (XArray[real_index] + scale(d[x]));
						}
					})
					.attr("y",function(d,i){				
						return focus_height * i;
					})
					.attr("height",function(d,i){
						return focus_height;
					})
					.attr("width",function(d){
						if(TypeArray[index]==true){
							return scale(d[x]);
						}else{
							return 10;
						}
					})
					.style("fill",function(d,i){
						var color = computeColor(getAttr(d,sortIndex),sortIndex);
						return color;
					})
					.attr("id",function(d,i){
						return "x"+index+"y"+(i+beginY_Index);
					})
					.classed(AttrName[index],true)	
					.on("mouseover",function(d,i){
						FirstSelectFilterNum = -1;
						FirstSelectRectNum = -1;
						d3.select(this).style("fill","green");
						var id = d3.select(this).attr("id");
						svg.select("#"+id).style("fill","green");
					})
					.on("mouseout",function(d,i){
						var color = computeColor(getAttr(d,sortIndex),sortIndex);
						d3.select(this).style("fill",color);
						var id = d3.select(this).attr("id");
						svg.select("#"+id).style("fill","red");
					});
					real_index++;
				}
			}
			index++;
		}
		//******************************************
		var append_top = YArray[upY_index];
		var append_bottom = append_top + div_height;
		svg.append("g")
		.append("line")
		.attr("x1",0)
		.attr("x2",InRectWidth)
		.attr("y1",append_top)
		.attr("y2",append_top)
		.attr("stroke","gray")
		.attr("stroke-width",1);
		//**************************
		svg.append("g")
		.append("line")
		.attr("x1",0)
		.attr("x2",InRectWidth)
		.attr("y1",append_bottom)
		.attr("y2",append_bottom)
		.attr("stroke","gray")
		.attr("stroke-width",1);
		//******************************************
		//add line to the add_div
		for(var i=beginY_Index;i<upY_index;i++){
			var index = i - beginY_Index +1;
			var y1 = index * focus_height;
			add_svg.append("g")
			.append("line")
			.attr("x1",0)
			.attr("x2",InRectWidth)
			.attr("y1",y1)
			.attr("y2",y1)
			.attr("stroke","gray")
			.attr("stroke-width",1);
		}
		//******************************************
		//add text to the add_div
		var text_baseballman;
		for(var i=beginY_Index;i<upY_index;i++){
			text_baseballman = render_baseballdata[i];
			var y_index = i - beginY_Index + 1;
			var text_y = focus_height * y_index - text_paddingY;
			var index = 0;
			var real_index = 0;
			var font_size = 12;
			for(x in text_baseballman){
				if(DisplayArray.indexOf(index)!=-1){
					var attr = baseballman[x];
					add_svg.append("g")
					.append("text")
					.attr("x",(XArray[real_index] + text_paddingX))
					.attr("y",text_y)
					.attr("class","person")
					.attr("font-size",font_size)
					.attr("font-family","arial")
					.text(text_baseballman[x]);
					real_index++;
				}
				index++;
			}
		}
	}
	//***************************************************************************************
	function ReadData(fileName){
		d3.csv(fileName,function(baseballman){
			//keep updating with the data
			FocusArray.splice(0,FocusArray.length);
			render_baseballdata.splice(0,render_baseballdata.length);
			minValue.splice(0,minValue.length);
			maxValue.splice(0,maxValue.length);
			AttrName.splice(0,AttrName.length);
			ManNum = baseballman.length;
			copy_baseballdata = baseballman.concat();
			render_baseballdata = baseballman;
			baseballdata = render_baseballdata;
			baseballman1 = baseballdata[0];
			humannum_sum = render_baseballdata.length;
			humannum = render_baseballdata.length;
			if(barheight>(InRectHeight-150)/humannum_sum){
				barheight = Math.floor(((InRectHeight-150)/humannum_sum)*100)/100;
			}
			humannum_min = 0, humannum_max = render_baseballdata.length;
			var count = 0;
			for(attribute in baseballman1){
				AttrName.push(attribute);
				count++;
			}
			AttrNum = count, AttrAllNum = count;
			for(var i=0;i<ManNum;i++){
				baseballman[i].num = i+1;
			}
			for(var i=0;i<=AttrAllNum;i++){
				TableArray[i] = new Array();
			}
			var i = 0;
			for(x in baseballman1){
				if(i<=AttrAllNum){
					for(var j=0;j<humannum_sum;j++){
						TableArray[i][j] = baseballman[j][x];
					}
					i++;
				}
			}
			for(var i=0;i<AttrNum;i++){
				SortObject[AttrName[i]] = true;
			}
			for(var i=0;i<AttrNum;i++){
				DisplayArray[i] = i;
			}
			button_width = Math.floor(ButtonInRectWidth/AttrNum);
			focus_height = 20;
			computeVarY();
			for(var i=0;i<=AttrNum;i++){
				AttrAllArray[i] = i;
			}
			XArray = new Array();
			for(var i=0;i<AttrAllNum;i++){
				XArray[i] = i * button_width + 3;
			}
			for(var i=0;i<=AttrAllNum;i++){
				if(i==0){
					minValue[i] = 0;
					maxValue[i] = 0;
					TypeArray[i] = true;
				}else{
					minValue[i] = Array.min(TableArray[i]);
					maxValue[i] = Array.max(TableArray[i]);
					if(isNaN(minValue[i])||isNaN(maxValue[i])){
						//category type data
						TypeArray[i] = new Array();
						for(var j=0;j<humannum_sum;j++){
							if(TypeArray[i].indexOf(TableArray[i][j])==-1){
								TypeArray[i].push(TableArray[i][j]);
							}
						}
						minValue[i] = 0;
						maxValue[i] = TypeArray[i].length;
					}else{
						//numerical type data
						TypeArray[i] = true;
					}
				}	
			}
			for(var i=0;i<minValue.length;i++){
				var difference = Math.floor((maxValue[i] - minValue[i]));
				quarter0Value[i] = Math.floor(minValue[i] + difference * cs_array[0]);
				quarter1Value[i] = Math.floor(minValue[i] + difference * cs_array[1]);
				quarter2Value[i] = Math.floor(minValue[i] + difference * cs_array[2]);
				quarter3Value[i] = Math.floor(minValue[i] + difference * cs_array[3]);
				quarter4Value[i] = Math.floor(minValue[i] + difference * cs_array[4]);
			}
			NamePArray.push(quarter4Value[sortIndex]+"");
			NamePArray.push(quarter3Value[sortIndex]+"");
			NamePArray.push(quarter2Value[sortIndex]+"");
			NamePArray.push(quarter1Value[sortIndex]+"");
			NamePArray.push(quarter0Value[sortIndex]+"");
			for(var i=0;i<AttrAllNum;i++){
				middleValue[i] = minValue[sortIndex] + cs_array[i] * (maxValue[sortIndex] - minValue[sortIndex]);
			}
			for(var i=0;i<AttrAllNum;i++){
				if(TypeArray[i]==true){
					ScaleArray[i] = d3.scale.linear()
					.range([0,button_width - 10])
					.domain([0,maxValue[i]]);
					type_height[i] = 0;
				}else{
					ScaleArray[i] = d3.scale.ordinal()
					.domain(TypeArray[i])
					.rangeBands([0,button_width-10]);
					type_height[i] = (button_width-10)/maxValue[i];
				}
			}	
			sortIndex = 1;
			SortFunction();	
			d3.select("#AttrButton")
				.selectAll(".attr_button").remove();
			d3.select("#AttrButton")
				.selectAll(".attr_button")
				.append("g")
				.data(AttrName)
				.enter()
				.append("button")
				.attr("class","attr_button")
				.style("height",InRectYMin+"px")
				.style("width", (button_width) +"px")
				.on("click",function(d,i){
					sortAttr(d,i);
				})
				.text(function(d,i){
					return AttrName[i];
				});
				select_option.splice(0,select_option.length);
				for(var i=1;i<AttrName.length;i++){
					select_option[i-1] = AttrName[i];
				}
				//***********************************************
				d3.select("#multiple_select")
				 .selectAll(".display_attr").remove();
				d3.select("#multiple_select")
				 .selectAll(".display_attr")
				 .append("g")
				 .data(select_option)
				 .enter()
				 .append("option")
				 .attr("selected","selected")
				 .attr("class","display_attr")
				 .attr("value", function(d){
					 return d;
				  })
				 .text(function(d,i){
					 return d;
				  });
				$("select#multiple_select").multiselect('refresh');
				//*************************************************
				d3.select("#grouping_select")
				  .selectAll(".sort_attr").remove();
				d3.select("#grouping_select")
				  .selectAll(".sort_attr")
				  .append("g")
				  .data(select_option)
				  .enter()
				  .append("option")
				  .attr("class","sort_attr")
				  .attr("value",function(d){
						return d;
				  })
				  .text(function(d,i){
						 return d;
				   });
				$("select#grouping_select").multiselect('refresh');
				//**************************************************
				 d3.select("#single_select")
				   .selectAll(".color_option").remove();
				d3.select("#single_select")
				   .selectAll(".color_option")
				   .append("g")
				   .data(filter_option)
				   .enter()
				   .append("option")
				   .attr("class","color_option")
				   .attr("value",function(d,i){
						return ColorArray[i];
					})
					.text(function(d,i){
						return d;
					});
				$("select#single_select").multiselect('refresh');
				sortIndex = 1;
				renderCSText();
				svg.selectAll("*").remove();
			tablelens();
		});
	}
</script>
</html>
